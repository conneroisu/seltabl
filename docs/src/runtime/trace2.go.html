<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Source: trace2.go in package runtime</title>
<link href="../../css/auto-v0.6.8.css" rel="stylesheet">
<script src="../../jvs/golds-v0.6.8.js"></script>
<body onload="onPageLoad()"><div>

<pre id="header"><code><span class="title">Source File</span>
	trace2.go

<span class="title">Belonging Package</span>
	<a href="../../pkg/runtime.html">runtime</a>
</code></pre>
<style>input[type=radio] {display: none;}
input[id=r0]:checked ~pre label[for=r0],
input[id=r1]:checked ~pre label[for=r1],
input[id=r2]:checked ~pre label[for=r2],
input[id=r3]:checked ~pre label[for=r3],
input[id=r4]:checked ~pre label[for=r4],
input[id=r5]:checked ~pre label[for=r5],
input[id=r6]:checked ~pre label[for=r6],
input[id=r7]:checked ~pre label[for=r7],
input[id=r8]:checked ~pre label[for=r8],
input[id=r9]:checked ~pre label[for=r9],
input[id=r10]:checked ~pre label[for=r10],
input[id=r11]:checked ~pre label[for=r11],
input[id=r12]:checked ~pre label[for=r12],
input[id=r13]:checked ~pre label[for=r13],
input[id=r14]:checked ~pre label[for=r14],
input[id=r15]:checked ~pre label[for=r15],
input[id=r16]:checked ~pre label[for=r16],
input[id=r17]:checked ~pre label[for=r17],
input[id=r18]:checked ~pre label[for=r18],
input[id=r19]:checked ~pre label[for=r19],
input[id=r20]:checked ~pre label[for=r20],
input[id=r21]:checked ~pre label[for=r21],
input[id=r22]:checked ~pre label[for=r22],
input[id=r23]:checked ~pre label[for=r23],
input[id=r24]:checked ~pre label[for=r24],
input[id=r25]:checked ~pre label[for=r25],
input[id=r26]:checked ~pre label[for=r26],
input[id=r27]:checked ~pre label[for=r27],
input[id=r28]:checked ~pre label[for=r28],
input[id=r29]:checked ~pre label[for=r29],
input[id=r30]:checked ~pre label[for=r30],
input[id=r31]:checked ~pre label[for=r31],
input[id=r32]:checked ~pre label[for=r32],
input[id=r33]:checked ~pre label[for=r33],
input[id=r34]:checked ~pre label[for=r34],
input[id=r35]:checked ~pre label[for=r35],
input[id=r36]:checked ~pre label[for=r36],
input[id=r37]:checked ~pre label[for=r37],
input[id=r38]:checked ~pre label[for=r38],
input[id=r39]:checked ~pre label[for=r39],
input[id=r40]:checked ~pre label[for=r40],
input[id=r41]:checked ~pre label[for=r41],
input[id=r42]:checked ~pre label[for=r42],
input[id=r43]:checked ~pre label[for=r43],
input[id=r44]:checked ~pre label[for=r44],
input[id=r45]:checked ~pre label[for=r45],
input[id=r46]:checked ~pre label[for=r46],
input[id=r47]:checked ~pre label[for=r47],
input[id=r48]:checked ~pre label[for=r48],
input[id=r49]:checked ~pre label[for=r49],
input[id=r50]:checked ~pre label[for=r50],
input[id=r51]:checked ~pre label[for=r51],
input[id=r52]:checked ~pre label[for=r52],
input[id=r53]:checked ~pre label[for=r53],
input[id=r54]:checked ~pre label[for=r54],
input[id=r55]:checked ~pre label[for=r55],
input[id=r56]:checked ~pre label[for=r56],
input[id=r57]:checked ~pre label[for=r57],
input[id=r58]:checked ~pre label[for=r58],
input[id=r59]:checked ~pre label[for=r59],
input[id=r60]:checked ~pre label[for=r60],
input[id=r61]:checked ~pre label[for=r61],
input[id=r62]:checked ~pre label[for=r62],
input[id=r63]:checked ~pre label[for=r63],
input[id=r64]:checked ~pre label[for=r64],
input[id=r65]:checked ~pre label[for=r65],
input[id=r66]:checked ~pre label[for=r66],
input[id=r67]:checked ~pre label[for=r67],
input[id=r68]:checked ~pre label[for=r68],
input[id=r69]:checked ~pre label[for=r69],
input[id=r70]:checked ~pre label[for=r70],
input[id=r71]:checked ~pre label[for=r71],
input[id=r72]:checked ~pre label[for=r72],
input[id=r73]:checked ~pre label[for=r73],
input[id=r74]:checked ~pre label[for=r74],
input[id=r75]:checked ~pre label[for=r75],
input[id=r76]:checked ~pre label[for=r76],
input[id=r77]:checked ~pre label[for=r77],
input[id=r78]:checked ~pre label[for=r78],
input[id=r79]:checked ~pre label[for=r79],
input[id=r80]:checked ~pre label[for=r80],
input[id=r81]:checked ~pre label[for=r81],
input[id=r82]:checked ~pre label[for=r82],
input[id=r83]:checked ~pre label[for=r83],
input[id=r84]:checked ~pre label[for=r84],
input[id=r85]:checked ~pre label[for=r85],
input[id=r86]:checked ~pre label[for=r86],
input[id=r87]:checked ~pre label[for=r87],
input[id=r88]:checked ~pre label[for=r88],
input[id=r89]:checked ~pre label[for=r89],
input[id=r90]:checked ~pre label[for=r90],
input[id=r91]:checked ~pre label[for=r91]
{background: #226; color: #ff8;}
input[id=i0]:checked ~pre .i0,
input[id=i1]:checked ~pre .i1
{background: brown; color: #eed;}
</style><input id="r0" type="radio" name="g"/>
<input id="r1" type="radio" name="g"/>
<input id="r2" type="radio" name="g"/>
<input id="r3" type="radio" name="g"/>
<input id="r4" type="radio" name="g"/>
<input id="r5" type="radio" name="g"/>
<input id="r6" type="radio" name="g"/>
<input id="r7" type="radio" name="g"/>
<input id="r8" type="radio" name="g"/>
<input id="r9" type="radio" name="g"/>
<input id="r10" type="radio" name="g"/>
<input id="r11" type="radio" name="g"/>
<input id="r12" type="radio" name="g"/>
<input id="r13" type="radio" name="g"/>
<input id="r14" type="radio" name="g"/>
<input id="r15" type="radio" name="g"/>
<input id="r16" type="radio" name="g"/>
<input id="r17" type="radio" name="g"/>
<input id="r18" type="radio" name="g"/>
<input id="r19" type="radio" name="g"/>
<input id="r20" type="radio" name="g"/>
<input id="r21" type="radio" name="g"/>
<input id="r22" type="radio" name="g"/>
<input id="r23" type="radio" name="g"/>
<input id="r24" type="radio" name="g"/>
<input id="r25" type="radio" name="g"/>
<input id="r26" type="radio" name="g"/>
<input id="r27" type="radio" name="g"/>
<input id="r28" type="radio" name="g"/>
<input id="r29" type="radio" name="g"/>
<input id="r30" type="radio" name="g"/>
<input id="r31" type="radio" name="g"/>
<input id="r32" type="radio" name="g"/>
<input id="r33" type="radio" name="g"/>
<input id="r34" type="radio" name="g"/>
<input id="r35" type="radio" name="g"/>
<input id="r36" type="radio" name="g"/>
<input id="r37" type="radio" name="g"/>
<input id="r38" type="radio" name="g"/>
<input id="r39" type="radio" name="g"/>
<input id="r40" type="radio" name="g"/>
<input id="r41" type="radio" name="g"/>
<input id="r42" type="radio" name="g"/>
<input id="r43" type="radio" name="g"/>
<input id="r44" type="radio" name="g"/>
<input id="r45" type="radio" name="g"/>
<input id="r46" type="radio" name="g"/>
<input id="r47" type="radio" name="g"/>
<input id="r48" type="radio" name="g"/>
<input id="r49" type="radio" name="g"/>
<input id="r50" type="radio" name="g"/>
<input id="r51" type="radio" name="g"/>
<input id="r52" type="radio" name="g"/>
<input id="r53" type="radio" name="g"/>
<input id="r54" type="radio" name="g"/>
<input id="r55" type="radio" name="g"/>
<input id="r56" type="radio" name="g"/>
<input id="r57" type="radio" name="g"/>
<input id="r58" type="radio" name="g"/>
<input id="r59" type="radio" name="g"/>
<input id="r60" type="radio" name="g"/>
<input id="r61" type="radio" name="g"/>
<input id="r62" type="radio" name="g"/>
<input id="r63" type="radio" name="g"/>
<input id="r64" type="radio" name="g"/>
<input id="r65" type="radio" name="g"/>
<input id="r66" type="radio" name="g"/>
<input id="r67" type="radio" name="g"/>
<input id="r68" type="radio" name="g"/>
<input id="r69" type="radio" name="g"/>
<input id="r70" type="radio" name="g"/>
<input id="r71" type="radio" name="g"/>
<input id="r72" type="radio" name="g"/>
<input id="r73" type="radio" name="g"/>
<input id="r74" type="radio" name="g"/>
<input id="r75" type="radio" name="g"/>
<input id="r76" type="radio" name="g"/>
<input id="r77" type="radio" name="g"/>
<input id="r78" type="radio" name="g"/>
<input id="r79" type="radio" name="g"/>
<input id="r80" type="radio" name="g"/>
<input id="r81" type="radio" name="g"/>
<input id="r82" type="radio" name="g"/>
<input id="r83" type="radio" name="g"/>
<input id="r84" type="radio" name="g"/>
<input id="r85" type="radio" name="g"/>
<input id="r86" type="radio" name="g"/>
<input id="r87" type="radio" name="g"/>
<input id="r88" type="radio" name="g"/>
<input id="r89" type="radio" name="g"/>
<input id="r90" type="radio" name="g"/>
<input id="r91" type="radio" name="g"/>
<input id="i0" type="radio" name="i"/>
<input id="i1" type="radio" name="i"/>

<pre class="line-numbers">
<span class="codeline" id="line-1"><code><span class="comment">// Copyright 2023 The Go Authors. All rights reserved.</span></code></span>
<span class="codeline" id="line-2"><code><span class="comment">// Use of this source code is governed by a BSD-style</span></code></span>
<span class="codeline" id="line-3"><code><span class="comment">// license that can be found in the LICENSE file.</span></code></span>
<span class="codeline" id="line-4"><code></code></span>
<span class="codeline" id="line-5"><code><span class="comment">//go:build goexperiment.exectracer2</span></code></span>
<span class="codeline" id="line-6"><code></code></span>
<span class="codeline" id="line-7"><code><span class="comment">// Go execution tracer.</span></code></span>
<span class="codeline" id="line-8"><code><span class="comment">// The tracer captures a wide range of execution events like goroutine</span></code></span>
<span class="codeline" id="line-9"><code><span class="comment">// creation/blocking/unblocking, syscall enter/exit/block, GC-related events,</span></code></span>
<span class="codeline" id="line-10"><code><span class="comment">// changes of heap size, processor start/stop, etc and writes them to a buffer</span></code></span>
<span class="codeline" id="line-11"><code><span class="comment">// in a compact form. A precise nanosecond-precision timestamp and a stack</span></code></span>
<span class="codeline" id="line-12"><code><span class="comment">// trace is captured for most events.</span></code></span>
<span class="codeline" id="line-13"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-14"><code><span class="comment">// Tracer invariants (to keep the synchronization making sense):</span></code></span>
<span class="codeline" id="line-15"><code><span class="comment">// - An m that has a trace buffer must be on either the allm or sched.freem lists.</span></code></span>
<span class="codeline" id="line-16"><code><span class="comment">// - Any trace buffer mutation must either be happening in traceAdvance or between</span></code></span>
<span class="codeline" id="line-17"><code><span class="comment">//   a traceAcquire and a subsequent traceRelease.</span></code></span>
<span class="codeline" id="line-18"><code><span class="comment">// - traceAdvance cannot return until the previous generation's buffers are all flushed.</span></code></span>
<span class="codeline" id="line-19"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-20"><code><span class="comment">// See https://go.dev/issue/60773 for a link to the full design.</span></code></span>
<span class="codeline" id="line-21"><code></code></span>
<span class="codeline" id="line-22"><code><span class="keyword">package</span> runtime</code></span>
<span class="codeline" id="line-23"><code></code></span>
<span class="codeline" id="line-24"><code><span class="keyword">import</span> (</code></span>
<span class="codeline" id="line-25"><code>	<label for="i0"><span class="lit-string i0">"runtime/internal/atomic"</span></label></code></span>
<span class="codeline" id="line-26"><code>	<label for="i1"><span class="lit-string i1">"unsafe"</span></label></code></span>
<span class="codeline" id="line-27"><code>)</code></span>
<span class="codeline" id="line-28"><code></code></span>
<span class="codeline" id="line-29"><code><span class="comment">// Trace state.</span></code></span>
<span class="codeline" id="line-30"><code></code></span>
<span class="codeline" id="line-31"><code><span class="comment">// trace is global tracing context.</span></code></span>
<span class="codeline" id="line-32"><code><span class="keyword">var</span> <a href="../../pkg/runtime.html#name-trace" class="ident">trace</a> <span class="keyword">struct</span> {</code></span>
<span class="codeline" id="line-33"><code>	<span class="comment">// trace.lock must only be acquired on the system stack where</span></code></span>
<span class="codeline" id="line-34"><code><span class="comment">	// stack splits cannot happen while it is held.</span></code></span>
<span class="codeline" id="line-35"><code>	lock <a href="runtime2.go.html#line-164" class="ident">mutex</a></code></span>
<span class="codeline" id="line-36"><code></code></span>
<span class="codeline" id="line-37"><code>	<span class="comment">// Trace buffer management.</span></code></span>
<span class="codeline" id="line-38"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-39"><code><span class="comment">	// First we check the empty list for any free buffers. If not, buffers</span></code></span>
<span class="codeline" id="line-40"><code><span class="comment">	// are allocated directly from the OS. Once they're filled up and/or</span></code></span>
<span class="codeline" id="line-41"><code><span class="comment">	// flushed, they end up on the full queue for trace.gen%2.</span></code></span>
<span class="codeline" id="line-42"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-43"><code><span class="comment">	// The trace reader takes buffers off the full list one-by-one and</span></code></span>
<span class="codeline" id="line-44"><code><span class="comment">	// places them into reading until they're finished being read from.</span></code></span>
<span class="codeline" id="line-45"><code><span class="comment">	// Then they're placed onto the empty list.</span></code></span>
<span class="codeline" id="line-46"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-47"><code><span class="comment">	// Protected by trace.lock.</span></code></span>
<span class="codeline" id="line-48"><code>	reading       *<a href="trace2buf.go.html#line-170" class="ident">traceBuf</a> <span class="comment">// buffer currently handed off to user</span></code></span>
<span class="codeline" id="line-49"><code>	empty         *<a href="trace2buf.go.html#line-170" class="ident">traceBuf</a> <span class="comment">// stack of empty buffers</span></code></span>
<span class="codeline" id="line-50"><code>	full          [<span class="lit-number">2</span>]<a href="trace2buf.go.html#line-126" class="ident">traceBufQueue</a></code></span>
<span class="codeline" id="line-51"><code>	workAvailable <a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-159" class="ident">Bool</a></code></span>
<span class="codeline" id="line-52"><code></code></span>
<span class="codeline" id="line-53"><code>	<span class="comment">// State for the trace reader goroutine.</span></code></span>
<span class="codeline" id="line-54"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-55"><code><span class="comment">	// Protected by trace.lock.</span></code></span>
<span class="codeline" id="line-56"><code>	readerGen     <a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-350" class="ident">Uintptr</a> <span class="comment">// the generation the reader is currently reading for</span></code></span>
<span class="codeline" id="line-57"><code>	flushedGen    <a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-350" class="ident">Uintptr</a> <span class="comment">// the last completed generation</span></code></span>
<span class="codeline" id="line-58"><code>	headerWritten <a href="../../pkg/builtin.html#name-bool" class="ident">bool</a>           <span class="comment">// whether ReadTrace has emitted trace header</span></code></span>
<span class="codeline" id="line-59"><code></code></span>
<span class="codeline" id="line-60"><code>	<span class="comment">// doneSema is used to synchronize the reader and traceAdvance. Specifically,</span></code></span>
<span class="codeline" id="line-61"><code><span class="comment">	// it notifies traceAdvance that the reader is done with a generation.</span></code></span>
<span class="codeline" id="line-62"><code><span class="comment">	// Both semaphores are 0 by default (so, acquires block). traceAdvance</span></code></span>
<span class="codeline" id="line-63"><code><span class="comment">	// attempts to acquire for gen%2 after flushing the last buffers for gen.</span></code></span>
<span class="codeline" id="line-64"><code><span class="comment">	// Meanwhile the reader releases the sema for gen%2 when it has finished</span></code></span>
<span class="codeline" id="line-65"><code><span class="comment">	// processing gen.</span></code></span>
<span class="codeline" id="line-66"><code>	doneSema [<span class="lit-number">2</span>]<a href="../../pkg/builtin.html#name-uint32" class="ident">uint32</a></code></span>
<span class="codeline" id="line-67"><code></code></span>
<span class="codeline" id="line-68"><code>	<span class="comment">// Trace data tables for deduplicating data going into the trace.</span></code></span>
<span class="codeline" id="line-69"><code><span class="comment">	// There are 2 of each: one for gen%2, one for 1-gen%2.</span></code></span>
<span class="codeline" id="line-70"><code>	stackTab  [<span class="lit-number">2</span>]<a href="trace2stack.go.html#line-85" class="ident">traceStackTable</a>  <span class="comment">// maps stack traces to unique ids</span></code></span>
<span class="codeline" id="line-71"><code>	stringTab [<span class="lit-number">2</span>]<a href="trace2string.go.html#line-17" class="ident">traceStringTable</a> <span class="comment">// maps strings to unique ids</span></code></span>
<span class="codeline" id="line-72"><code></code></span>
<span class="codeline" id="line-73"><code>	<span class="comment">// cpuLogRead accepts CPU profile samples from the signal handler where</span></code></span>
<span class="codeline" id="line-74"><code><span class="comment">	// they're generated. There are two profBufs here: one for gen%2, one for</span></code></span>
<span class="codeline" id="line-75"><code><span class="comment">	// 1-gen%2. These profBufs use a three-word header to hold the IDs of the P, G,</span></code></span>
<span class="codeline" id="line-76"><code><span class="comment">	// and M (respectively) that were active at the time of the sample. Because</span></code></span>
<span class="codeline" id="line-77"><code><span class="comment">	// profBuf uses a record with all zeros in its header to indicate overflow,</span></code></span>
<span class="codeline" id="line-78"><code><span class="comment">	// we make sure to make the P field always non-zero: The ID of a real P will</span></code></span>
<span class="codeline" id="line-79"><code><span class="comment">	// start at bit 1, and bit 0 will be set. Samples that arrive while no P is</span></code></span>
<span class="codeline" id="line-80"><code><span class="comment">	// running (such as near syscalls) will set the first header field to 0b10.</span></code></span>
<span class="codeline" id="line-81"><code><span class="comment">	// This careful handling of the first header field allows us to store ID of</span></code></span>
<span class="codeline" id="line-82"><code><span class="comment">	// the active G directly in the second field, even though that will be 0</span></code></span>
<span class="codeline" id="line-83"><code><span class="comment">	// when sampling g0.</span></code></span>
<span class="codeline" id="line-84"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-85"><code><span class="comment">	// Initialization and teardown of these fields is protected by traceAdvanceSema.</span></code></span>
<span class="codeline" id="line-86"><code>	cpuLogRead  [<span class="lit-number">2</span>]*<a href="profbuf.go.html#line-87" class="ident">profBuf</a></code></span>
<span class="codeline" id="line-87"><code>	signalLock  <a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-185" class="ident">Uint32</a>              <span class="comment">// protects use of the following member, only usable in signal handlers</span></code></span>
<span class="codeline" id="line-88"><code>	cpuLogWrite [<span class="lit-number">2</span>]<a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-518" class="ident">Pointer</a>[<a href="profbuf.go.html#line-87" class="ident">profBuf</a>] <span class="comment">// copy of cpuLogRead for use in signal handlers, set without signalLock</span></code></span>
<span class="codeline" id="line-89"><code>	cpuSleep    *<a href="#line-909" class="ident">wakeableSleep</a></code></span>
<span class="codeline" id="line-90"><code>	cpuLogDone  &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>{}</code></span>
<span class="codeline" id="line-91"><code>	cpuBuf      [<span class="lit-number">2</span>]*<a href="trace2buf.go.html#line-170" class="ident">traceBuf</a></code></span>
<span class="codeline" id="line-92"><code></code></span>
<span class="codeline" id="line-93"><code>	reader <a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-518" class="ident">Pointer</a>[<a href="runtime2.go.html#line-422" class="ident">g</a>] <span class="comment">// goroutine that called ReadTrace, or nil</span></code></span>
<span class="codeline" id="line-94"><code></code></span>
<span class="codeline" id="line-95"><code>	<span class="comment">// Fast mappings from enumerations to string IDs that are prepopulated</span></code></span>
<span class="codeline" id="line-96"><code><span class="comment">	// in the trace.</span></code></span>
<span class="codeline" id="line-97"><code>	markWorkerLabels [<span class="lit-number">2</span>][<a href="../../pkg/builtin.html#name-len" class="ident">len</a>(<a href="mgc.go.html#line-279" class="ident">gcMarkWorkerModeStrings</a>)]<a href="trace2event.go.html#line-88" class="ident">traceArg</a></code></span>
<span class="codeline" id="line-98"><code>	goStopReasons    [<span class="lit-number">2</span>][<a href="../../pkg/builtin.html#name-len" class="ident">len</a>(<a href="trace2runtime.go.html#line-134" class="ident">traceGoStopReasonStrings</a>)]<a href="trace2event.go.html#line-88" class="ident">traceArg</a></code></span>
<span class="codeline" id="line-99"><code>	goBlockReasons   [<span class="lit-number">2</span>][<a href="../../pkg/builtin.html#name-len" class="ident">len</a>(<a href="trace2runtime.go.html#line-104" class="ident">traceBlockReasonStrings</a>)]<a href="trace2event.go.html#line-88" class="ident">traceArg</a></code></span>
<span class="codeline" id="line-100"><code></code></span>
<span class="codeline" id="line-101"><code>	<span class="comment">// Trace generation counter.</span></code></span>
<span class="codeline" id="line-102"><code>	gen            <a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-350" class="ident">Uintptr</a></code></span>
<span class="codeline" id="line-103"><code>	lastNonZeroGen <a href="../../pkg/builtin.html#name-uintptr" class="ident">uintptr</a> <span class="comment">// last non-zero value of gen</span></code></span>
<span class="codeline" id="line-104"><code></code></span>
<span class="codeline" id="line-105"><code>	<span class="comment">// shutdown is set when we are waiting for trace reader to finish after setting gen to 0</span></code></span>
<span class="codeline" id="line-106"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-107"><code><span class="comment">	// Writes protected by trace.lock.</span></code></span>
<span class="codeline" id="line-108"><code>	shutdown <a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-159" class="ident">Bool</a></code></span>
<span class="codeline" id="line-109"><code></code></span>
<span class="codeline" id="line-110"><code>	<span class="comment">// Number of goroutines in syscall exiting slow path.</span></code></span>
<span class="codeline" id="line-111"><code>	exitingSyscall <a href="../../pkg/runtime/internal/atomic.html" class="ident i0">atomic</a>.<a href="internal/atomic/types.go.html#line-12" class="ident">Int32</a></code></span>
<span class="codeline" id="line-112"><code></code></span>
<span class="codeline" id="line-113"><code>	<span class="comment">// seqGC is the sequence counter for GC begin/end.</span></code></span>
<span class="codeline" id="line-114"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-115"><code><span class="comment">	// Mutated only during stop-the-world.</span></code></span>
<span class="codeline" id="line-116"><code>	seqGC <a href="../../pkg/builtin.html#name-uint64" class="ident">uint64</a></code></span>
<span class="codeline" id="line-117"><code>}</code></span>
<span class="codeline" id="line-118"><code></code></span>
<span class="codeline" id="line-119"><code><span class="comment">// Trace public API.</span></code></span>
<span class="codeline" id="line-120"><code></code></span>
<span class="codeline" id="line-121"><code><span class="keyword">var</span> (</code></span>
<span class="codeline" id="line-122"><code>	<a href="../../pkg/runtime.html#name-traceAdvanceSema" class="ident">traceAdvanceSema</a>  <a href="../../pkg/builtin.html#name-uint32" class="ident">uint32</a> = <span class="lit-number">1</span></code></span>
<span class="codeline" id="line-123"><code>	<a href="../../pkg/runtime.html#name-traceShutdownSema" class="ident">traceShutdownSema</a> <a href="../../pkg/builtin.html#name-uint32" class="ident">uint32</a> = <span class="lit-number">1</span></code></span>
<span class="codeline" id="line-124"><code>)</code></span>
<span class="codeline" id="line-125"><code></code></span>
<span class="codeline" id="line-126"><code><span class="comment">// StartTrace enables tracing for the current process.</span></code></span>
<span class="codeline" id="line-127"><code><span class="comment">// While tracing, the data will be buffered and available via [ReadTrace].</span></code></span>
<span class="codeline" id="line-128"><code><span class="comment">// StartTrace returns an error if tracing is already enabled.</span></code></span>
<span class="codeline" id="line-129"><code><span class="comment">// Most clients should use the [runtime/trace] package or the [testing] package's</span></code></span>
<span class="codeline" id="line-130"><code><span class="comment">// -test.trace flag instead of calling StartTrace directly.</span></code></span>
<span class="codeline" id="line-131"><code><span class="keyword">func</span> <label for="r0" class="ident"><a href="../../pkg/runtime.html#name-StartTrace" class="ident">StartTrace</a></label>() <a href="../../pkg/builtin.html#name-error" class="ident">error</a> {</code></span>
<span class="codeline" id="line-132"><code>	<span class="keyword">if</span> <a href="trace2runtime.go.html#line-143" class="ident">traceEnabled</a>() || <a href="trace2runtime.go.html#line-148" class="ident">traceShuttingDown</a>() {</code></span>
<span class="codeline" id="line-133"><code>		<span class="keyword">return</span> <a href="error.go.html#line-73" class="ident">errorString</a>(<span class="lit-string">"tracing is already enabled"</span>)</code></span>
<span class="codeline" id="line-134"><code>	}</code></span>
<span class="codeline" id="line-135"><code>	<span class="comment">// Block until cleanup of the last trace is done.</span></code></span>
<span class="codeline" id="line-136"><code>	<a href="sema.go.html#line-110" class="ident">semacquire</a>(&amp;<a href="#line-123" class="ident">traceShutdownSema</a>)</code></span>
<span class="codeline" id="line-137"><code>	<a href="sema.go.html#line-171" class="ident">semrelease</a>(&amp;<a href="#line-123" class="ident">traceShutdownSema</a>)</code></span>
<span class="codeline" id="line-138"><code></code></span>
<span class="codeline" id="line-139"><code>	<span class="comment">// Hold traceAdvanceSema across trace start, since we'll want it on</span></code></span>
<span class="codeline" id="line-140"><code><span class="comment">	// the other side of tracing being enabled globally.</span></code></span>
<span class="codeline" id="line-141"><code>	<a href="sema.go.html#line-110" class="ident">semacquire</a>(&amp;<a href="#line-122" class="ident">traceAdvanceSema</a>)</code></span>
<span class="codeline" id="line-142"><code></code></span>
<span class="codeline" id="line-143"><code>	<span class="comment">// Initialize CPU profile -&gt; trace ingestion.</span></code></span>
<span class="codeline" id="line-144"><code>	<a href="trace2cpu.go.html#line-14" class="ident">traceInitReadCPU</a>()</code></span>
<span class="codeline" id="line-145"><code></code></span>
<span class="codeline" id="line-146"><code>	<span class="comment">// Compute the first generation for this StartTrace.</span></code></span>
<span class="codeline" id="line-147"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-148"><code><span class="comment">	// Note: we start from the last non-zero generation rather than 1 so we</span></code></span>
<span class="codeline" id="line-149"><code><span class="comment">	// can avoid resetting all the arrays indexed by gen%2 or gen%3. There's</span></code></span>
<span class="codeline" id="line-150"><code><span class="comment">	// more than one of each per m, p, and goroutine.</span></code></span>
<span class="codeline" id="line-151"><code>	<label for="r1" class="ident">firstGen</label> := <a href="#line-643" class="ident">traceNextGen</a>(<a href="#line-32" class="ident">trace</a>.<a href="#line-103" class="ident">lastNonZeroGen</a>)</code></span>
<span class="codeline" id="line-152"><code></code></span>
<span class="codeline" id="line-153"><code>	<span class="comment">// Reset GC sequencer.</span></code></span>
<span class="codeline" id="line-154"><code>	<a href="#line-32" class="ident">trace</a>.<a href="#line-116" class="ident">seqGC</a> = <span class="lit-number">1</span></code></span>
<span class="codeline" id="line-155"><code></code></span>
<span class="codeline" id="line-156"><code>	<span class="comment">// Reset trace reader state.</span></code></span>
<span class="codeline" id="line-157"><code>	<a href="#line-32" class="ident">trace</a>.<a href="#line-58" class="ident">headerWritten</a> = <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-158"><code>	<a href="#line-32" class="ident">trace</a>.<a href="#line-56" class="ident">readerGen</a>.<a href="internal/atomic/types.go.html#line-378" class="ident">Store</a>(<label for="r1" class="ident">firstGen</label>)</code></span>
<span class="codeline" id="line-159"><code>	<a href="#line-32" class="ident">trace</a>.<a href="#line-57" class="ident">flushedGen</a>.<a href="internal/atomic/types.go.html#line-378" class="ident">Store</a>(<span class="lit-number">0</span>)</code></span>
<span class="codeline" id="line-160"><code></code></span>
<span class="codeline" id="line-161"><code>	<span class="comment">// Register some basic strings in the string tables.</span></code></span>
<span class="codeline" id="line-162"><code>	<a href="#line-656" class="ident">traceRegisterLabelsAndReasons</a>(<label for="r1" class="ident">firstGen</label>)</code></span>
<span class="codeline" id="line-163"><code></code></span>
<span class="codeline" id="line-164"><code>	<span class="comment">// Stop the world.</span></code></span>
<span class="codeline" id="line-165"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-166"><code><span class="comment">	// The purpose of stopping the world is to make sure that no goroutine is in a</span></code></span>
<span class="codeline" id="line-167"><code><span class="comment">	// context where it could emit an event by bringing all goroutines to a safe point</span></code></span>
<span class="codeline" id="line-168"><code><span class="comment">	// with no opportunity to transition.</span></code></span>
<span class="codeline" id="line-169"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-170"><code><span class="comment">	// The exception to this rule are goroutines that are concurrently exiting a syscall.</span></code></span>
<span class="codeline" id="line-171"><code><span class="comment">	// Those will all be forced into the syscalling slow path, and we'll just make sure</span></code></span>
<span class="codeline" id="line-172"><code><span class="comment">	// that we don't observe any goroutines in that critical section before starting</span></code></span>
<span class="codeline" id="line-173"><code><span class="comment">	// the world again.</span></code></span>
<span class="codeline" id="line-174"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-175"><code><span class="comment">	// A good follow-up question to this is why stopping the world is necessary at all</span></code></span>
<span class="codeline" id="line-176"><code><span class="comment">	// given that we have traceAcquire and traceRelease. Unfortunately, those only help</span></code></span>
<span class="codeline" id="line-177"><code><span class="comment">	// us when tracing is already active (for performance, so when tracing is off the</span></code></span>
<span class="codeline" id="line-178"><code><span class="comment">	// tracing seqlock is left untouched). The main issue here is subtle: we're going to</span></code></span>
<span class="codeline" id="line-179"><code><span class="comment">	// want to obtain a correct starting status for each goroutine, but there are windows</span></code></span>
<span class="codeline" id="line-180"><code><span class="comment">	// of time in which we could read and emit an incorrect status. Specifically:</span></code></span>
<span class="codeline" id="line-181"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-182"><code><span class="comment">	//	trace := traceAcquire()</span></code></span>
<span class="codeline" id="line-183"><code><span class="comment">	//  // &lt;----&gt; problem window</span></code></span>
<span class="codeline" id="line-184"><code><span class="comment">	//	casgstatus(gp, _Gwaiting, _Grunnable)</span></code></span>
<span class="codeline" id="line-185"><code><span class="comment">	//	if trace.ok() {</span></code></span>
<span class="codeline" id="line-186"><code><span class="comment">	//		trace.GoUnpark(gp, 2)</span></code></span>
<span class="codeline" id="line-187"><code><span class="comment">	//		traceRelease(trace)</span></code></span>
<span class="codeline" id="line-188"><code><span class="comment">	//	}</span></code></span>
<span class="codeline" id="line-189"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-190"><code><span class="comment">	// More precisely, if we readgstatus for a gp while another goroutine is in the problem</span></code></span>
<span class="codeline" id="line-191"><code><span class="comment">	// window and that goroutine didn't observe that tracing had begun, then we might write</span></code></span>
<span class="codeline" id="line-192"><code><span class="comment">	// a GoStatus(GoWaiting) event for that goroutine, but it won't trace an event marking</span></code></span>
<span class="codeline" id="line-193"><code><span class="comment">	// the transition from GoWaiting to GoRunnable. The trace will then be broken, because</span></code></span>
<span class="codeline" id="line-194"><code><span class="comment">	// future events will be emitted assuming the tracer sees GoRunnable.</span></code></span>
<span class="codeline" id="line-195"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-196"><code><span class="comment">	// In short, what we really need here is to make sure that the next time *any goroutine*</span></code></span>
<span class="codeline" id="line-197"><code><span class="comment">	// hits a traceAcquire, it sees that the trace is enabled.</span></code></span>
<span class="codeline" id="line-198"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-199"><code><span class="comment">	// Note also that stopping the world is necessary to make sure sweep-related events are</span></code></span>
<span class="codeline" id="line-200"><code><span class="comment">	// coherent. Since the world is stopped and sweeps are non-preemptible, we can never start</span></code></span>
<span class="codeline" id="line-201"><code><span class="comment">	// the world and see an unpaired sweep 'end' event. Other parts of the tracer rely on this.</span></code></span>
<span class="codeline" id="line-202"><code>	<label for="r2" class="ident">stw</label> := <a href="proc.go.html#line-1339" class="ident">stopTheWorld</a>(<a href="proc.go.html#line-1270" class="ident">stwStartTrace</a>)</code></span>
<span class="codeline" id="line-203"><code></code></span>
<span class="codeline" id="line-204"><code>	<span class="comment">// Prevent sysmon from running any code that could generate events.</span></code></span>
<span class="codeline" id="line-205"><code>	<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<a href="runtime2.go.html#line-1192" class="ident">sched</a>.<a href="runtime2.go.html#line-881" class="ident">sysmonlock</a>)</code></span>
<span class="codeline" id="line-206"><code></code></span>
<span class="codeline" id="line-207"><code>	<span class="comment">// Reset mSyscallID on all Ps while we have them stationary and the trace is disabled.</span></code></span>
<span class="codeline" id="line-208"><code>	<span class="keyword">for</span> <label for="r3" class="ident">_</label>, <label for="r4" class="ident">pp</label> := <span class="keyword">range</span> <a href="runtime2.go.html#line-1200" class="ident">allp</a> {</code></span>
<span class="codeline" id="line-209"><code>		<label for="r4" class="ident">pp</label>.<a href="runtime2.go.html#line-707" class="ident">trace</a>.<a href="trace2runtime.go.html#line-39" class="ident">mSyscallID</a> = -<span class="lit-number">1</span></code></span>
<span class="codeline" id="line-210"><code>	}</code></span>
<span class="codeline" id="line-211"><code></code></span>
<span class="codeline" id="line-212"><code>	<span class="comment">// Start tracing.</span></code></span>
<span class="codeline" id="line-213"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-214"><code><span class="comment">	// After this executes, other Ms may start creating trace buffers and emitting</span></code></span>
<span class="codeline" id="line-215"><code><span class="comment">	// data into them.</span></code></span>
<span class="codeline" id="line-216"><code>	<a href="#line-32" class="ident">trace</a>.<a href="#line-102" class="ident">gen</a>.<a href="internal/atomic/types.go.html#line-378" class="ident">Store</a>(<label for="r1" class="ident">firstGen</label>)</code></span>
<span class="codeline" id="line-217"><code></code></span>
<span class="codeline" id="line-218"><code>	<span class="comment">// Wait for exitingSyscall to drain.</span></code></span>
<span class="codeline" id="line-219"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-220"><code><span class="comment">	// It may not monotonically decrease to zero, but in the limit it will always become</span></code></span>
<span class="codeline" id="line-221"><code><span class="comment">	// zero because the world is stopped and there are no available Ps for syscall-exited</span></code></span>
<span class="codeline" id="line-222"><code><span class="comment">	// goroutines to run on.</span></code></span>
<span class="codeline" id="line-223"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-224"><code><span class="comment">	// Because we set gen before checking this, and because exitingSyscall is always incremented</span></code></span>
<span class="codeline" id="line-225"><code><span class="comment">	// *after* traceAcquire (which checks gen), we can be certain that when exitingSyscall is zero</span></code></span>
<span class="codeline" id="line-226"><code><span class="comment">	// that any goroutine that goes to exit a syscall from then on *must* observe the new gen.</span></code></span>
<span class="codeline" id="line-227"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-228"><code><span class="comment">	// The critical section on each goroutine here is going to be quite short, so the likelihood</span></code></span>
<span class="codeline" id="line-229"><code><span class="comment">	// that we observe a zero value is high.</span></code></span>
<span class="codeline" id="line-230"><code>	<span class="keyword">for</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-111" class="ident">exitingSyscall</a>.<a href="internal/atomic/types.go.html#line-20" class="ident">Load</a>() != <span class="lit-number">0</span> {</code></span>
<span class="codeline" id="line-231"><code>		<a href="os_linux.go.html#line-442" class="ident">osyield</a>()</code></span>
<span class="codeline" id="line-232"><code>	}</code></span>
<span class="codeline" id="line-233"><code></code></span>
<span class="codeline" id="line-234"><code>	<span class="comment">// Record some initial pieces of information.</span></code></span>
<span class="codeline" id="line-235"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-236"><code><span class="comment">	// N.B. This will also emit a status event for this goroutine.</span></code></span>
<span class="codeline" id="line-237"><code>	<label for="r5" class="ident">tl</label> := <a href="trace2runtime.go.html#line-172" class="ident">traceAcquire</a>()</code></span>
<span class="codeline" id="line-238"><code>	<label for="r5" class="ident">tl</label>.<a href="trace2runtime.go.html#line-259" class="ident">Gomaxprocs</a>(<a href="runtime2.go.html#line-1189" class="ident">gomaxprocs</a>)  <span class="comment">// Get this as early in the trace as possible. See comment in traceAdvance.</span></code></span>
<span class="codeline" id="line-239"><code>	<label for="r5" class="ident">tl</label>.<a href="trace2runtime.go.html#line-315" class="ident">STWStart</a>(<a href="proc.go.html#line-1270" class="ident">stwStartTrace</a>) <span class="comment">// We didn't trace this above, so trace it now.</span></code></span>
<span class="codeline" id="line-240"><code></code></span>
<span class="codeline" id="line-241"><code>	<span class="comment">// Record the fact that a GC is active, if applicable.</span></code></span>
<span class="codeline" id="line-242"><code>	<span class="keyword">if</span> <a href="mgc.go.html#line-212" class="ident">gcphase</a> == <a href="mgc.go.html#line-231" class="ident">_GCmark</a> || <a href="mgc.go.html#line-212" class="ident">gcphase</a> == <a href="mgc.go.html#line-232" class="ident">_GCmarktermination</a> {</code></span>
<span class="codeline" id="line-243"><code>		<label for="r5" class="ident">tl</label>.<a href="trace2runtime.go.html#line-285" class="ident">GCActive</a>()</code></span>
<span class="codeline" id="line-244"><code>	}</code></span>
<span class="codeline" id="line-245"><code></code></span>
<span class="codeline" id="line-246"><code>	<span class="comment">// Record the heap goal so we have it at the very beginning of the trace.</span></code></span>
<span class="codeline" id="line-247"><code>	<label for="r5" class="ident">tl</label>.<a href="trace2runtime.go.html#line-546" class="ident">HeapGoal</a>()</code></span>
<span class="codeline" id="line-248"><code></code></span>
<span class="codeline" id="line-249"><code>	<span class="comment">// Make sure a ProcStatus is emitted for every P, while we're here.</span></code></span>
<span class="codeline" id="line-250"><code>	<span class="keyword">for</span> <label for="r6" class="ident">_</label>, <label for="r7" class="ident">pp</label> := <span class="keyword">range</span> <a href="runtime2.go.html#line-1200" class="ident">allp</a> {</code></span>
<span class="codeline" id="line-251"><code>		<label for="r5" class="ident">tl</label>.<a href="trace2buf.go.html#line-33" class="ident">writer</a>().<a href="trace2status.go.html#line-72" class="ident">writeProcStatusForP</a>(<label for="r7" class="ident">pp</label>, <label for="r7" class="ident">pp</label> == <label for="r5" class="ident">tl</label>.<a href="trace2runtime.go.html#line-156" class="ident">mp</a>.<a href="runtime2.go.html#line-565" class="ident">p</a>.<a href="runtime2.go.html#line-293" class="ident">ptr</a>()).<a href="trace2buf.go.html#line-49" class="ident">end</a>()</code></span>
<span class="codeline" id="line-252"><code>	}</code></span>
<span class="codeline" id="line-253"><code>	<a href="trace2runtime.go.html#line-237" class="ident">traceRelease</a>(<label for="r5" class="ident">tl</label>)</code></span>
<span class="codeline" id="line-254"><code></code></span>
<span class="codeline" id="line-255"><code>	<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="runtime2.go.html#line-1192" class="ident">sched</a>.<a href="runtime2.go.html#line-881" class="ident">sysmonlock</a>)</code></span>
<span class="codeline" id="line-256"><code>	<a href="proc.go.html#line-1368" class="ident">startTheWorld</a>(<label for="r2" class="ident">stw</label>)</code></span>
<span class="codeline" id="line-257"><code></code></span>
<span class="codeline" id="line-258"><code>	<a href="trace2cpu.go.html#line-37" class="ident">traceStartReadCPU</a>()</code></span>
<span class="codeline" id="line-259"><code>	<a href="#line-868" class="ident">traceAdvancer</a>.<a href="#line-876" class="ident">start</a>()</code></span>
<span class="codeline" id="line-260"><code></code></span>
<span class="codeline" id="line-261"><code>	<a href="sema.go.html#line-171" class="ident">semrelease</a>(&amp;<a href="#line-122" class="ident">traceAdvanceSema</a>)</code></span>
<span class="codeline" id="line-262"><code>	<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a></code></span>
<span class="codeline" id="line-263"><code>}</code></span>
<span class="codeline" id="line-264"><code></code></span>
<span class="codeline" id="line-265"><code><span class="comment">// StopTrace stops tracing, if it was previously enabled.</span></code></span>
<span class="codeline" id="line-266"><code><span class="comment">// StopTrace only returns after all the reads for the trace have completed.</span></code></span>
<span class="codeline" id="line-267"><code><span class="keyword">func</span> <label for="r8" class="ident"><a href="../../pkg/runtime.html#name-StopTrace" class="ident">StopTrace</a></label>() {</code></span>
<span class="codeline" id="line-268"><code>	<a href="#line-276" class="ident">traceAdvance</a>(<a href="../../pkg/builtin.html#name-true" class="ident">true</a>)</code></span>
<span class="codeline" id="line-269"><code>}</code></span>
<span class="codeline" id="line-270"><code></code></span>
<span class="codeline" id="line-271"><code><span class="comment">// traceAdvance moves tracing to the next generation, and cleans up the current generation,</span></code></span>
<span class="codeline" id="line-272"><code><span class="comment">// ensuring that it's flushed out before returning. If stopTrace is true, it disables tracing</span></code></span>
<span class="codeline" id="line-273"><code><span class="comment">// altogether instead of advancing to the next generation.</span></code></span>
<span class="codeline" id="line-274"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-275"><code><span class="comment">// traceAdvanceSema must not be held.</span></code></span>
<span class="codeline" id="line-276"><code><span class="keyword">func</span> <label for="r9" class="ident"><a href="../../pkg/runtime.html#name-traceAdvance" class="ident">traceAdvance</a></label>(<label for="r10" class="ident">stopTrace</label> <a href="../../pkg/builtin.html#name-bool" class="ident">bool</a>) {</code></span>
<span class="codeline" id="line-277"><code>	<a href="sema.go.html#line-110" class="ident">semacquire</a>(&amp;<a href="#line-122" class="ident">traceAdvanceSema</a>)</code></span>
<span class="codeline" id="line-278"><code></code></span>
<span class="codeline" id="line-279"><code>	<span class="comment">// Get the gen that we're advancing from. In this function we don't really care much</span></code></span>
<span class="codeline" id="line-280"><code><span class="comment">	// about the generation we're advancing _into_ since we'll do all the cleanup in this</span></code></span>
<span class="codeline" id="line-281"><code><span class="comment">	// generation for the next advancement.</span></code></span>
<span class="codeline" id="line-282"><code>	<label for="r11" class="ident">gen</label> := <a href="#line-32" class="ident">trace</a>.<a href="#line-102" class="ident">gen</a>.<a href="internal/atomic/types.go.html#line-358" class="ident">Load</a>()</code></span>
<span class="codeline" id="line-283"><code>	<span class="keyword">if</span> <label for="r11" class="ident">gen</label> == <span class="lit-number">0</span> {</code></span>
<span class="codeline" id="line-284"><code>		<span class="comment">// We may end up here traceAdvance is called concurrently with StopTrace.</span></code></span>
<span class="codeline" id="line-285"><code>		<a href="sema.go.html#line-171" class="ident">semrelease</a>(&amp;<a href="#line-122" class="ident">traceAdvanceSema</a>)</code></span>
<span class="codeline" id="line-286"><code>		<span class="keyword">return</span></code></span>
<span class="codeline" id="line-287"><code>	}</code></span>
<span class="codeline" id="line-288"><code></code></span>
<span class="codeline" id="line-289"><code>	<span class="comment">// Write an EvFrequency event for this generation.</span></code></span>
<span class="codeline" id="line-290"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-291"><code><span class="comment">	// N.B. This may block for quite a while to get a good frequency estimate, so make sure we do</span></code></span>
<span class="codeline" id="line-292"><code><span class="comment">	// this here and not e.g. on the trace reader.</span></code></span>
<span class="codeline" id="line-293"><code>	<a href="trace2time.go.html#line-74" class="ident">traceFrequency</a>(<label for="r11" class="ident">gen</label>)</code></span>
<span class="codeline" id="line-294"><code></code></span>
<span class="codeline" id="line-295"><code>	<span class="comment">// Collect all the untraced Gs.</span></code></span>
<span class="codeline" id="line-296"><code>	<span class="keyword">type</span> <label for="r12" class="ident">untracedG</label> <span class="keyword">struct</span> {</code></span>
<span class="codeline" id="line-297"><code>		<label for="r13" class="ident">gp</label>           *<a href="runtime2.go.html#line-422" class="ident">g</a></code></span>
<span class="codeline" id="line-298"><code>		<label for="r14" class="ident">goid</label>         <a href="../../pkg/builtin.html#name-uint64" class="ident">uint64</a></code></span>
<span class="codeline" id="line-299"><code>		<label for="r15" class="ident">mid</label>          <a href="../../pkg/builtin.html#name-int64" class="ident">int64</a></code></span>
<span class="codeline" id="line-300"><code>		<label for="r16" class="ident">status</label>       <a href="../../pkg/builtin.html#name-uint32" class="ident">uint32</a></code></span>
<span class="codeline" id="line-301"><code>		<label for="r17" class="ident">waitreason</label>   <a href="runtime2.go.html#line-1092" class="ident">waitReason</a></code></span>
<span class="codeline" id="line-302"><code>		<label for="r18" class="ident">inMarkAssist</label> <a href="../../pkg/builtin.html#name-bool" class="ident">bool</a></code></span>
<span class="codeline" id="line-303"><code>	}</code></span>
<span class="codeline" id="line-304"><code>	<span class="keyword">var</span> <label for="r19" class="ident">untracedGs</label> []<label for="r12" class="ident">untracedG</label></code></span>
<span class="codeline" id="line-305"><code>	<a href="proc.go.html#line-673" class="ident">forEachGRace</a>(<span class="keyword">func</span>(<label for="r20" class="ident">gp</label> *<a href="runtime2.go.html#line-422" class="ident">g</a>) {</code></span>
<span class="codeline" id="line-306"><code>		<span class="comment">// Make absolutely sure all Gs are ready for the next</span></code></span>
<span class="codeline" id="line-307"><code><span class="comment">		// generation. We need to do this even for dead Gs because</span></code></span>
<span class="codeline" id="line-308"><code><span class="comment">		// they may come alive with a new identity, and its status</span></code></span>
<span class="codeline" id="line-309"><code><span class="comment">		// traced bookkeeping might end up being stale.</span></code></span>
<span class="codeline" id="line-310"><code><span class="comment">		// We may miss totally new goroutines, but they'll always</span></code></span>
<span class="codeline" id="line-311"><code><span class="comment">		// have clean bookkeeping.</span></code></span>
<span class="codeline" id="line-312"><code>		<label for="r20" class="ident">gp</label>.<a href="runtime2.go.html#line-518" class="ident">trace</a>.<a href="trace2status.go.html#line-193" class="ident">readyNextGen</a>(<label for="r11" class="ident">gen</label>)</code></span>
<span class="codeline" id="line-313"><code>		<span class="comment">// If the status was traced, nothing else to do.</span></code></span>
<span class="codeline" id="line-314"><code>		<span class="keyword">if</span> <label for="r20" class="ident">gp</label>.<a href="runtime2.go.html#line-518" class="ident">trace</a>.<a href="trace2status.go.html#line-200" class="ident">statusWasTraced</a>(<label for="r11" class="ident">gen</label>) {</code></span>
<span class="codeline" id="line-315"><code>			<span class="keyword">return</span></code></span>
<span class="codeline" id="line-316"><code>		}</code></span>
<span class="codeline" id="line-317"><code>		<span class="comment">// Scribble down information about this goroutine.</span></code></span>
<span class="codeline" id="line-318"><code>		<label for="r21" class="ident">ug</label> := <label for="r12" class="ident">untracedG</label>{<label for="r13" class="ident">gp</label>: <label for="r20" class="ident">gp</label>, <label for="r15" class="ident">mid</label>: -<span class="lit-number">1</span>}</code></span>
<span class="codeline" id="line-319"><code>		<a href="stubs.go.html#line-58" class="ident">systemstack</a>(<span class="keyword">func</span>() {</code></span>
<span class="codeline" id="line-320"><code>			<label for="r22" class="ident">me</label> := <a href="stubs.go.html#line-22" class="ident">getg</a>().<a href="runtime2.go.html#line-436" class="ident">m</a>.<a href="runtime2.go.html#line-563" class="ident">curg</a></code></span>
<span class="codeline" id="line-321"><code>			<span class="comment">// We don't have to handle this G status transition because we</span></code></span>
<span class="codeline" id="line-322"><code><span class="comment">			// already eliminated ourselves from consideration above.</span></code></span>
<span class="codeline" id="line-323"><code>			<a href="proc.go.html#line-1204" class="ident">casGToWaiting</a>(<label for="r22" class="ident">me</label>, <a href="runtime2.go.html#line-46" class="ident">_Grunning</a>, <a href="runtime2.go.html#line-1128" class="ident">waitReasonTraceGoroutineStatus</a>)</code></span>
<span class="codeline" id="line-324"><code>			<span class="comment">// We need to suspend and take ownership of the G to safely read its</span></code></span>
<span class="codeline" id="line-325"><code><span class="comment">			// goid. Note that we can't actually emit the event at this point</span></code></span>
<span class="codeline" id="line-326"><code><span class="comment">			// because we might stop the G in a window where it's unsafe to write</span></code></span>
<span class="codeline" id="line-327"><code><span class="comment">			// events based on the G's status. We need the global trace buffer flush</span></code></span>
<span class="codeline" id="line-328"><code><span class="comment">			// coming up to make sure we're not racing with the G.</span></code></span>
<span class="codeline" id="line-329"><code><span class="comment">			//</span></code></span>
<span class="codeline" id="line-330"><code><span class="comment">			// It should be very unlikely that we try to preempt a running G here.</span></code></span>
<span class="codeline" id="line-331"><code><span class="comment">			// The only situation that we might is that we're racing with a G</span></code></span>
<span class="codeline" id="line-332"><code><span class="comment">			// that's running for the first time in this generation. Therefore,</span></code></span>
<span class="codeline" id="line-333"><code><span class="comment">			// this should be relatively fast.</span></code></span>
<span class="codeline" id="line-334"><code>			<label for="r23" class="ident">s</label> := <a href="preempt.go.html#line-104" class="ident">suspendG</a>(<label for="r20" class="ident">gp</label>)</code></span>
<span class="codeline" id="line-335"><code>			<span class="keyword">if</span> !<label for="r23" class="ident">s</label>.<a href="preempt.go.html#line-67" class="ident">dead</a> {</code></span>
<span class="codeline" id="line-336"><code>				<label for="r21" class="ident">ug</label>.<label for="r14" class="ident">goid</label> = <label for="r23" class="ident">s</label>.<a href="preempt.go.html#line-61" class="ident">g</a>.<a href="runtime2.go.html#line-457" class="ident">goid</a></code></span>
<span class="codeline" id="line-337"><code>				<span class="keyword">if</span> <label for="r23" class="ident">s</label>.<a href="preempt.go.html#line-61" class="ident">g</a>.<a href="runtime2.go.html#line-436" class="ident">m</a> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-338"><code>					<label for="r21" class="ident">ug</label>.<label for="r15" class="ident">mid</label> = <a href="../../pkg/builtin.html#name-int64" class="ident">int64</a>(<label for="r23" class="ident">s</label>.<a href="preempt.go.html#line-61" class="ident">g</a>.<a href="runtime2.go.html#line-436" class="ident">m</a>.<a href="runtime2.go.html#line-557" class="ident">procid</a>)</code></span>
<span class="codeline" id="line-339"><code>				}</code></span>
<span class="codeline" id="line-340"><code>				<label for="r21" class="ident">ug</label>.<label for="r16" class="ident">status</label> = <a href="proc.go.html#line-1039" class="ident">readgstatus</a>(<label for="r23" class="ident">s</label>.<a href="preempt.go.html#line-61" class="ident">g</a>) &amp;^ <a href="runtime2.go.html#line-101" class="ident">_Gscan</a></code></span>
<span class="codeline" id="line-341"><code>				<label for="r21" class="ident">ug</label>.<label for="r17" class="ident">waitreason</label> = <label for="r23" class="ident">s</label>.<a href="preempt.go.html#line-61" class="ident">g</a>.<a href="runtime2.go.html#line-460" class="ident">waitreason</a></code></span>
<span class="codeline" id="line-342"><code>				<label for="r21" class="ident">ug</label>.<label for="r18" class="ident">inMarkAssist</label> = <label for="r23" class="ident">s</label>.<a href="preempt.go.html#line-61" class="ident">g</a>.<a href="runtime2.go.html#line-485" class="ident">inMarkAssist</a></code></span>
<span class="codeline" id="line-343"><code>			}</code></span>
<span class="codeline" id="line-344"><code>			<a href="preempt.go.html#line-257" class="ident">resumeG</a>(<label for="r23" class="ident">s</label>)</code></span>
<span class="codeline" id="line-345"><code>			<a href="proc.go.html#line-1105" class="ident">casgstatus</a>(<label for="r22" class="ident">me</label>, <a href="runtime2.go.html#line-61" class="ident">_Gwaiting</a>, <a href="runtime2.go.html#line-46" class="ident">_Grunning</a>)</code></span>
<span class="codeline" id="line-346"><code>		})</code></span>
<span class="codeline" id="line-347"><code>		<span class="keyword">if</span> <label for="r21" class="ident">ug</label>.<label for="r14" class="ident">goid</label> != <span class="lit-number">0</span> {</code></span>
<span class="codeline" id="line-348"><code>			<label for="r19" class="ident">untracedGs</label> = <a href="../../pkg/builtin.html#name-append" class="ident">append</a>(<label for="r19" class="ident">untracedGs</label>, <label for="r21" class="ident">ug</label>)</code></span>
<span class="codeline" id="line-349"><code>		}</code></span>
<span class="codeline" id="line-350"><code>	})</code></span>
<span class="codeline" id="line-351"><code></code></span>
<span class="codeline" id="line-352"><code>	<span class="keyword">if</span> !<label for="r10" class="ident">stopTrace</label> {</code></span>
<span class="codeline" id="line-353"><code>		<span class="comment">// Re-register runtime goroutine labels and stop/block reasons.</span></code></span>
<span class="codeline" id="line-354"><code>		<a href="#line-656" class="ident">traceRegisterLabelsAndReasons</a>(<a href="#line-643" class="ident">traceNextGen</a>(<label for="r11" class="ident">gen</label>))</code></span>
<span class="codeline" id="line-355"><code>	}</code></span>
<span class="codeline" id="line-356"><code></code></span>
<span class="codeline" id="line-357"><code>	<span class="comment">// Now that we've done some of the heavy stuff, prevent the world from stopping.</span></code></span>
<span class="codeline" id="line-358"><code><span class="comment">	// This is necessary to ensure the consistency of the STW events. If we're feeling</span></code></span>
<span class="codeline" id="line-359"><code><span class="comment">	// adventurous we could lift this restriction and add a STWActive event, but the</span></code></span>
<span class="codeline" id="line-360"><code><span class="comment">	// cost of maintaining this consistency is low. We're not going to hold this semaphore</span></code></span>
<span class="codeline" id="line-361"><code><span class="comment">	// for very long and most STW periods are very short.</span></code></span>
<span class="codeline" id="line-362"><code><span class="comment">	// Once we hold worldsema, prevent preemption as well so we're not interrupted partway</span></code></span>
<span class="codeline" id="line-363"><code><span class="comment">	// through this. We want to get this done as soon as possible.</span></code></span>
<span class="codeline" id="line-364"><code>	<a href="sema.go.html#line-110" class="ident">semacquire</a>(&amp;<a href="proc.go.html#line-1409" class="ident">worldsema</a>)</code></span>
<span class="codeline" id="line-365"><code>	<label for="r24" class="ident">mp</label> := <a href="runtime1.go.html#line-579" class="ident">acquirem</a>()</code></span>
<span class="codeline" id="line-366"><code></code></span>
<span class="codeline" id="line-367"><code>	<span class="comment">// Advance the generation or stop the trace.</span></code></span>
<span class="codeline" id="line-368"><code>	<a href="#line-32" class="ident">trace</a>.<a href="#line-103" class="ident">lastNonZeroGen</a> = <label for="r11" class="ident">gen</label></code></span>
<span class="codeline" id="line-369"><code>	<span class="keyword">if</span> <label for="r10" class="ident">stopTrace</label> {</code></span>
<span class="codeline" id="line-370"><code>		<a href="stubs.go.html#line-58" class="ident">systemstack</a>(<span class="keyword">func</span>() {</code></span>
<span class="codeline" id="line-371"><code>			<span class="comment">// Ordering is important here. Set shutdown first, then disable tracing,</span></code></span>
<span class="codeline" id="line-372"><code><span class="comment">			// so that conditions like (traceEnabled() || traceShuttingDown()) have</span></code></span>
<span class="codeline" id="line-373"><code><span class="comment">			// no opportunity to be false. Hold the trace lock so this update appears</span></code></span>
<span class="codeline" id="line-374"><code><span class="comment">			// atomic to the trace reader.</span></code></span>
<span class="codeline" id="line-375"><code>			<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-376"><code>			<a href="#line-32" class="ident">trace</a>.<a href="#line-108" class="ident">shutdown</a>.<a href="internal/atomic/types.go.html#line-174" class="ident">Store</a>(<a href="../../pkg/builtin.html#name-true" class="ident">true</a>)</code></span>
<span class="codeline" id="line-377"><code>			<a href="#line-32" class="ident">trace</a>.<a href="#line-102" class="ident">gen</a>.<a href="internal/atomic/types.go.html#line-378" class="ident">Store</a>(<span class="lit-number">0</span>)</code></span>
<span class="codeline" id="line-378"><code>			<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-379"><code>		})</code></span>
<span class="codeline" id="line-380"><code>	} <span class="keyword">else</span> {</code></span>
<span class="codeline" id="line-381"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-102" class="ident">gen</a>.<a href="internal/atomic/types.go.html#line-378" class="ident">Store</a>(<a href="#line-643" class="ident">traceNextGen</a>(<label for="r11" class="ident">gen</label>))</code></span>
<span class="codeline" id="line-382"><code>	}</code></span>
<span class="codeline" id="line-383"><code></code></span>
<span class="codeline" id="line-384"><code>	<span class="comment">// Emit a ProcsChange event so we have one on record for each generation.</span></code></span>
<span class="codeline" id="line-385"><code><span class="comment">	// Let's emit it as soon as possible so that downstream tools can rely on the value</span></code></span>
<span class="codeline" id="line-386"><code><span class="comment">	// being there fairly soon in a generation.</span></code></span>
<span class="codeline" id="line-387"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-388"><code><span class="comment">	// It's important that we do this before allowing stop-the-worlds again,</span></code></span>
<span class="codeline" id="line-389"><code><span class="comment">	// because the procs count could change.</span></code></span>
<span class="codeline" id="line-390"><code>	<span class="keyword">if</span> !<label for="r10" class="ident">stopTrace</label> {</code></span>
<span class="codeline" id="line-391"><code>		<label for="r25" class="ident">tl</label> := <a href="trace2runtime.go.html#line-172" class="ident">traceAcquire</a>()</code></span>
<span class="codeline" id="line-392"><code>		<label for="r25" class="ident">tl</label>.<a href="trace2runtime.go.html#line-259" class="ident">Gomaxprocs</a>(<a href="runtime2.go.html#line-1189" class="ident">gomaxprocs</a>)</code></span>
<span class="codeline" id="line-393"><code>		<a href="trace2runtime.go.html#line-237" class="ident">traceRelease</a>(<label for="r25" class="ident">tl</label>)</code></span>
<span class="codeline" id="line-394"><code>	}</code></span>
<span class="codeline" id="line-395"><code></code></span>
<span class="codeline" id="line-396"><code>	<span class="comment">// Emit a GCActive event in the new generation if necessary.</span></code></span>
<span class="codeline" id="line-397"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-398"><code><span class="comment">	// It's important that we do this before allowing stop-the-worlds again,</span></code></span>
<span class="codeline" id="line-399"><code><span class="comment">	// because that could emit global GC-related events.</span></code></span>
<span class="codeline" id="line-400"><code>	<span class="keyword">if</span> !<label for="r10" class="ident">stopTrace</label> &amp;&amp; (<a href="mgc.go.html#line-212" class="ident">gcphase</a> == <a href="mgc.go.html#line-231" class="ident">_GCmark</a> || <a href="mgc.go.html#line-212" class="ident">gcphase</a> == <a href="mgc.go.html#line-232" class="ident">_GCmarktermination</a>) {</code></span>
<span class="codeline" id="line-401"><code>		<label for="r26" class="ident">tl</label> := <a href="trace2runtime.go.html#line-172" class="ident">traceAcquire</a>()</code></span>
<span class="codeline" id="line-402"><code>		<label for="r26" class="ident">tl</label>.<a href="trace2runtime.go.html#line-285" class="ident">GCActive</a>()</code></span>
<span class="codeline" id="line-403"><code>		<a href="trace2runtime.go.html#line-237" class="ident">traceRelease</a>(<label for="r26" class="ident">tl</label>)</code></span>
<span class="codeline" id="line-404"><code>	}</code></span>
<span class="codeline" id="line-405"><code></code></span>
<span class="codeline" id="line-406"><code>	<span class="comment">// Preemption is OK again after this. If the world stops or whatever it's fine.</span></code></span>
<span class="codeline" id="line-407"><code><span class="comment">	// We're just cleaning up the last generation after this point.</span></code></span>
<span class="codeline" id="line-408"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-409"><code><span class="comment">	// We also don't care if the GC starts again after this for the same reasons.</span></code></span>
<span class="codeline" id="line-410"><code>	<a href="runtime1.go.html#line-586" class="ident">releasem</a>(<label for="r24" class="ident">mp</label>)</code></span>
<span class="codeline" id="line-411"><code>	<a href="sema.go.html#line-171" class="ident">semrelease</a>(&amp;<a href="proc.go.html#line-1409" class="ident">worldsema</a>)</code></span>
<span class="codeline" id="line-412"><code></code></span>
<span class="codeline" id="line-413"><code>	<span class="comment">// Snapshot allm and freem.</span></code></span>
<span class="codeline" id="line-414"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-415"><code><span class="comment">	// Snapshotting after the generation counter update is sufficient.</span></code></span>
<span class="codeline" id="line-416"><code><span class="comment">	// Because an m must be on either allm or sched.freem if it has an active trace</span></code></span>
<span class="codeline" id="line-417"><code><span class="comment">	// buffer, new threads added to allm after this point must necessarily observe</span></code></span>
<span class="codeline" id="line-418"><code><span class="comment">	// the new generation number (sched.lock acts as a barrier).</span></code></span>
<span class="codeline" id="line-419"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-420"><code><span class="comment">	// Threads that exit before this point and are on neither list explicitly</span></code></span>
<span class="codeline" id="line-421"><code><span class="comment">	// flush their own buffers in traceThreadDestroy.</span></code></span>
<span class="codeline" id="line-422"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-423"><code><span class="comment">	// Snapshotting freem is necessary because Ms can continue to emit events</span></code></span>
<span class="codeline" id="line-424"><code><span class="comment">	// while they're still on that list. Removal from sched.freem is serialized with</span></code></span>
<span class="codeline" id="line-425"><code><span class="comment">	// this snapshot, so either we'll capture an m on sched.freem and race with</span></code></span>
<span class="codeline" id="line-426"><code><span class="comment">	// the removal to flush its buffers (resolved by traceThreadDestroy acquiring</span></code></span>
<span class="codeline" id="line-427"><code><span class="comment">	// the thread's seqlock, which one of us must win, so at least its old gen buffer</span></code></span>
<span class="codeline" id="line-428"><code><span class="comment">	// will be flushed in time for the new generation) or it will have flushed its</span></code></span>
<span class="codeline" id="line-429"><code><span class="comment">	// buffers before we snapshotted it to begin with.</span></code></span>
<span class="codeline" id="line-430"><code>	<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<a href="runtime2.go.html#line-1192" class="ident">sched</a>.<a href="runtime2.go.html#line-804" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-431"><code>	<label for="r27" class="ident">mToFlush</label> := <a href="runtime2.go.html#line-1188" class="ident">allm</a></code></span>
<span class="codeline" id="line-432"><code>	<span class="keyword">for</span> <label for="r28" class="ident">mp</label> := <label for="r27" class="ident">mToFlush</label>; <label for="r28" class="ident">mp</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>; <label for="r28" class="ident">mp</label> = <label for="r28" class="ident">mp</label>.<a href="runtime2.go.html#line-591" class="ident">alllink</a> {</code></span>
<span class="codeline" id="line-433"><code>		<label for="r28" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-31" class="ident">link</a> = <label for="r28" class="ident">mp</label>.<a href="runtime2.go.html#line-591" class="ident">alllink</a></code></span>
<span class="codeline" id="line-434"><code>	}</code></span>
<span class="codeline" id="line-435"><code>	<span class="keyword">for</span> <label for="r29" class="ident">mp</label> := <a href="runtime2.go.html#line-1192" class="ident">sched</a>.<a href="runtime2.go.html#line-858" class="ident">freem</a>; <label for="r29" class="ident">mp</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>; <label for="r29" class="ident">mp</label> = <label for="r29" class="ident">mp</label>.<a href="runtime2.go.html#line-609" class="ident">freelink</a> {</code></span>
<span class="codeline" id="line-436"><code>		<label for="r29" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-31" class="ident">link</a> = <label for="r27" class="ident">mToFlush</label></code></span>
<span class="codeline" id="line-437"><code>		<label for="r27" class="ident">mToFlush</label> = <label for="r29" class="ident">mp</label></code></span>
<span class="codeline" id="line-438"><code>	}</code></span>
<span class="codeline" id="line-439"><code>	<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="runtime2.go.html#line-1192" class="ident">sched</a>.<a href="runtime2.go.html#line-804" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-440"><code></code></span>
<span class="codeline" id="line-441"><code>	<span class="comment">// Iterate over our snapshot, flushing every buffer until we're done.</span></code></span>
<span class="codeline" id="line-442"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-443"><code><span class="comment">	// Because trace writers read the generation while the seqlock is</span></code></span>
<span class="codeline" id="line-444"><code><span class="comment">	// held, we can be certain that when there are no writers there are</span></code></span>
<span class="codeline" id="line-445"><code><span class="comment">	// also no stale generation values left. Therefore, it's safe to flush</span></code></span>
<span class="codeline" id="line-446"><code><span class="comment">	// any buffers that remain in that generation's slot.</span></code></span>
<span class="codeline" id="line-447"><code>	<span class="keyword">const</span> <label for="r30" class="ident">debugDeadlock</label> = <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-448"><code>	<a href="stubs.go.html#line-58" class="ident">systemstack</a>(<span class="keyword">func</span>() {</code></span>
<span class="codeline" id="line-449"><code>		<span class="comment">// Track iterations for some rudimentary deadlock detection.</span></code></span>
<span class="codeline" id="line-450"><code>		<label for="r31" class="ident">i</label> := <span class="lit-number">0</span></code></span>
<span class="codeline" id="line-451"><code>		<label for="r32" class="ident">detectedDeadlock</label> := <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-452"><code></code></span>
<span class="codeline" id="line-453"><code>		<span class="keyword">for</span> <label for="r27" class="ident">mToFlush</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-454"><code>			<label for="r33" class="ident">prev</label> := &amp;<label for="r27" class="ident">mToFlush</label></code></span>
<span class="codeline" id="line-455"><code>			<span class="keyword">for</span> <label for="r34" class="ident">mp</label> := *<label for="r33" class="ident">prev</label>; <label for="r34" class="ident">mp</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>; {</code></span>
<span class="codeline" id="line-456"><code>				<span class="keyword">if</span> <label for="r34" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-29" class="ident">seqlock</a>.<a href="internal/atomic/types.go.html#line-358" class="ident">Load</a>()%<span class="lit-number">2</span> != <span class="lit-number">0</span> {</code></span>
<span class="codeline" id="line-457"><code>					<span class="comment">// The M is writing. Come back to it later.</span></code></span>
<span class="codeline" id="line-458"><code>					<label for="r33" class="ident">prev</label> = &amp;<label for="r34" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-31" class="ident">link</a></code></span>
<span class="codeline" id="line-459"><code>					<label for="r34" class="ident">mp</label> = <label for="r34" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-31" class="ident">link</a></code></span>
<span class="codeline" id="line-460"><code>					<span class="keyword">continue</span></code></span>
<span class="codeline" id="line-461"><code>				}</code></span>
<span class="codeline" id="line-462"><code>				<span class="comment">// Flush the trace buffer.</span></code></span>
<span class="codeline" id="line-463"><code><span class="comment">				//</span></code></span>
<span class="codeline" id="line-464"><code><span class="comment">				// trace.lock needed for traceBufFlush, but also to synchronize</span></code></span>
<span class="codeline" id="line-465"><code><span class="comment">				// with traceThreadDestroy, which flushes both buffers unconditionally.</span></code></span>
<span class="codeline" id="line-466"><code>				<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-467"><code>				<label for="r35" class="ident">bufp</label> := &amp;<label for="r34" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-30" class="ident">buf</a>[<label for="r11" class="ident">gen</label>%<span class="lit-number">2</span>]</code></span>
<span class="codeline" id="line-468"><code>				<span class="keyword">if</span> *<label for="r35" class="ident">bufp</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-469"><code>					<a href="trace2buf.go.html#line-240" class="ident">traceBufFlush</a>(*<label for="r35" class="ident">bufp</label>, <label for="r11" class="ident">gen</label>)</code></span>
<span class="codeline" id="line-470"><code>					*<label for="r35" class="ident">bufp</label> = <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a></code></span>
<span class="codeline" id="line-471"><code>				}</code></span>
<span class="codeline" id="line-472"><code>				<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-473"><code></code></span>
<span class="codeline" id="line-474"><code>				<span class="comment">// Remove the m from the flush list.</span></code></span>
<span class="codeline" id="line-475"><code>				*<label for="r33" class="ident">prev</label> = <label for="r34" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-31" class="ident">link</a></code></span>
<span class="codeline" id="line-476"><code>				<label for="r34" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-31" class="ident">link</a> = <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a></code></span>
<span class="codeline" id="line-477"><code>				<label for="r34" class="ident">mp</label> = *<label for="r33" class="ident">prev</label></code></span>
<span class="codeline" id="line-478"><code>			}</code></span>
<span class="codeline" id="line-479"><code>			<span class="comment">// Yield only if we're going to be going around the loop again.</span></code></span>
<span class="codeline" id="line-480"><code>			<span class="keyword">if</span> <label for="r27" class="ident">mToFlush</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-481"><code>				<a href="os_linux.go.html#line-442" class="ident">osyield</a>()</code></span>
<span class="codeline" id="line-482"><code>			}</code></span>
<span class="codeline" id="line-483"><code></code></span>
<span class="codeline" id="line-484"><code>			<span class="keyword">if</span> <label for="r30" class="ident">debugDeadlock</label> {</code></span>
<span class="codeline" id="line-485"><code>				<span class="comment">// Try to detect a deadlock. We probably shouldn't loop here</span></code></span>
<span class="codeline" id="line-486"><code><span class="comment">				// this many times.</span></code></span>
<span class="codeline" id="line-487"><code>				<span class="keyword">if</span> <label for="r31" class="ident">i</label> &gt; <span class="lit-number">100000</span> &amp;&amp; !<label for="r32" class="ident">detectedDeadlock</label> {</code></span>
<span class="codeline" id="line-488"><code>					<label for="r32" class="ident">detectedDeadlock</label> = <a href="../../pkg/builtin.html#name-true" class="ident">true</a></code></span>
<span class="codeline" id="line-489"><code>					<a href="../../pkg/builtin.html#name-println" class="ident">println</a>(<span class="lit-string">"runtime: failing to flush"</span>)</code></span>
<span class="codeline" id="line-490"><code>					<span class="keyword">for</span> <label for="r36" class="ident">mp</label> := <label for="r27" class="ident">mToFlush</label>; <label for="r36" class="ident">mp</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>; <label for="r36" class="ident">mp</label> = <label for="r36" class="ident">mp</label>.<a href="runtime2.go.html#line-610" class="ident">trace</a>.<a href="trace2runtime.go.html#line-31" class="ident">link</a> {</code></span>
<span class="codeline" id="line-491"><code>						<a href="../../pkg/builtin.html#name-print" class="ident">print</a>(<span class="lit-string">"runtime: m="</span>, <label for="r36" class="ident">mp</label>.<a href="runtime2.go.html#line-568" class="ident">id</a>, <span class="lit-string">"\n"</span>)</code></span>
<span class="codeline" id="line-492"><code>					}</code></span>
<span class="codeline" id="line-493"><code>				}</code></span>
<span class="codeline" id="line-494"><code>				<label for="r31" class="ident">i</label>++</code></span>
<span class="codeline" id="line-495"><code>			}</code></span>
<span class="codeline" id="line-496"><code>		}</code></span>
<span class="codeline" id="line-497"><code>	})</code></span>
<span class="codeline" id="line-498"><code></code></span>
<span class="codeline" id="line-499"><code>	<span class="comment">// At this point, the old generation is fully flushed minus stack and string</span></code></span>
<span class="codeline" id="line-500"><code><span class="comment">	// tables, CPU samples, and goroutines that haven't run at all during the last</span></code></span>
<span class="codeline" id="line-501"><code><span class="comment">	// generation.</span></code></span>
<span class="codeline" id="line-502"><code></code></span>
<span class="codeline" id="line-503"><code>	<span class="comment">// Check to see if any Gs still haven't had events written out for them.</span></code></span>
<span class="codeline" id="line-504"><code>	<label for="r37" class="ident">statusWriter</label> := <a href="trace2buf.go.html#line-44" class="ident">unsafeTraceWriter</a>(<label for="r11" class="ident">gen</label>, <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>)</code></span>
<span class="codeline" id="line-505"><code>	<span class="keyword">for</span> <label for="r38" class="ident">_</label>, <label for="r39" class="ident">ug</label> := <span class="keyword">range</span> <label for="r19" class="ident">untracedGs</label> {</code></span>
<span class="codeline" id="line-506"><code>		<span class="keyword">if</span> <label for="r39" class="ident">ug</label>.<label for="r13" class="ident">gp</label>.<a href="runtime2.go.html#line-518" class="ident">trace</a>.<a href="trace2status.go.html#line-200" class="ident">statusWasTraced</a>(<label for="r11" class="ident">gen</label>) {</code></span>
<span class="codeline" id="line-507"><code>			<span class="comment">// It was traced, we don't need to do anything.</span></code></span>
<span class="codeline" id="line-508"><code>			<span class="keyword">continue</span></code></span>
<span class="codeline" id="line-509"><code>		}</code></span>
<span class="codeline" id="line-510"><code>		<span class="comment">// It still wasn't traced. Because we ensured all Ms stopped writing trace</span></code></span>
<span class="codeline" id="line-511"><code><span class="comment">		// events to the last generation, that must mean the G never had its status</span></code></span>
<span class="codeline" id="line-512"><code><span class="comment">		// traced in gen between when we recorded it and now. If that's true, the goid</span></code></span>
<span class="codeline" id="line-513"><code><span class="comment">		// and status we recorded then is exactly what we want right now.</span></code></span>
<span class="codeline" id="line-514"><code>		<label for="r40" class="ident">status</label> := <a href="trace2status.go.html#line-127" class="ident">goStatusToTraceGoStatus</a>(<label for="r39" class="ident">ug</label>.<label for="r16" class="ident">status</label>, <label for="r39" class="ident">ug</label>.<label for="r17" class="ident">waitreason</label>)</code></span>
<span class="codeline" id="line-515"><code>		<label for="r37" class="ident">statusWriter</label> = <label for="r37" class="ident">statusWriter</label>.<a href="trace2status.go.html#line-51" class="ident">writeGoStatus</a>(<label for="r39" class="ident">ug</label>.<label for="r14" class="ident">goid</label>, <label for="r39" class="ident">ug</label>.<label for="r15" class="ident">mid</label>, <label for="r40" class="ident">status</label>, <label for="r39" class="ident">ug</label>.<label for="r18" class="ident">inMarkAssist</label>)</code></span>
<span class="codeline" id="line-516"><code>	}</code></span>
<span class="codeline" id="line-517"><code>	<label for="r37" class="ident">statusWriter</label>.<a href="trace2buf.go.html#line-70" class="ident">flush</a>().<a href="trace2buf.go.html#line-49" class="ident">end</a>()</code></span>
<span class="codeline" id="line-518"><code></code></span>
<span class="codeline" id="line-519"><code>	<span class="comment">// Read everything out of the last gen's CPU profile buffer.</span></code></span>
<span class="codeline" id="line-520"><code>	<a href="trace2cpu.go.html#line-118" class="ident">traceReadCPU</a>(<label for="r11" class="ident">gen</label>)</code></span>
<span class="codeline" id="line-521"><code></code></span>
<span class="codeline" id="line-522"><code>	<a href="stubs.go.html#line-58" class="ident">systemstack</a>(<span class="keyword">func</span>() {</code></span>
<span class="codeline" id="line-523"><code>		<span class="comment">// Flush CPU samples, stacks, and strings for the last generation. This is safe,</span></code></span>
<span class="codeline" id="line-524"><code><span class="comment">		// because we're now certain no M is writing to the last generation.</span></code></span>
<span class="codeline" id="line-525"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-526"><code><span class="comment">		// Ordering is important here. traceCPUFlush may generate new stacks and dumping</span></code></span>
<span class="codeline" id="line-527"><code><span class="comment">		// stacks may generate new strings.</span></code></span>
<span class="codeline" id="line-528"><code>		<a href="trace2cpu.go.html#line-203" class="ident">traceCPUFlush</a>(<label for="r11" class="ident">gen</label>)</code></span>
<span class="codeline" id="line-529"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-70" class="ident">stackTab</a>[<label for="r11" class="ident">gen</label>%<span class="lit-number">2</span>].<a href="trace2stack.go.html#line-107" class="ident">dump</a>(<label for="r11" class="ident">gen</label>)</code></span>
<span class="codeline" id="line-530"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-71" class="ident">stringTab</a>[<label for="r11" class="ident">gen</label>%<span class="lit-number">2</span>].<a href="trace2string.go.html#line-92" class="ident">reset</a>(<label for="r11" class="ident">gen</label>)</code></span>
<span class="codeline" id="line-531"><code></code></span>
<span class="codeline" id="line-532"><code>		<span class="comment">// That's it. This generation is done producing buffers.</span></code></span>
<span class="codeline" id="line-533"><code>		<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-534"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-57" class="ident">flushedGen</a>.<a href="internal/atomic/types.go.html#line-378" class="ident">Store</a>(<label for="r11" class="ident">gen</label>)</code></span>
<span class="codeline" id="line-535"><code>		<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-536"><code>	})</code></span>
<span class="codeline" id="line-537"><code></code></span>
<span class="codeline" id="line-538"><code>	<span class="keyword">if</span> <label for="r10" class="ident">stopTrace</label> {</code></span>
<span class="codeline" id="line-539"><code>		<a href="sema.go.html#line-110" class="ident">semacquire</a>(&amp;<a href="#line-123" class="ident">traceShutdownSema</a>)</code></span>
<span class="codeline" id="line-540"><code></code></span>
<span class="codeline" id="line-541"><code>		<span class="comment">// Finish off CPU profile reading.</span></code></span>
<span class="codeline" id="line-542"><code>		<a href="trace2cpu.go.html#line-77" class="ident">traceStopReadCPU</a>()</code></span>
<span class="codeline" id="line-543"><code>	} <span class="keyword">else</span> {</code></span>
<span class="codeline" id="line-544"><code>		<span class="comment">// Go over each P and emit a status event for it if necessary.</span></code></span>
<span class="codeline" id="line-545"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-546"><code><span class="comment">		// We do this at the beginning of the new generation instead of the</span></code></span>
<span class="codeline" id="line-547"><code><span class="comment">		// end like we do for goroutines because forEachP doesn't give us a</span></code></span>
<span class="codeline" id="line-548"><code><span class="comment">		// hook to skip Ps that have already been traced. Since we have to</span></code></span>
<span class="codeline" id="line-549"><code><span class="comment">		// preempt all Ps anyway, might as well stay consistent with StartTrace</span></code></span>
<span class="codeline" id="line-550"><code><span class="comment">		// which does this during the STW.</span></code></span>
<span class="codeline" id="line-551"><code>		<a href="sema.go.html#line-110" class="ident">semacquire</a>(&amp;<a href="proc.go.html#line-1409" class="ident">worldsema</a>)</code></span>
<span class="codeline" id="line-552"><code>		<a href="proc.go.html#line-1894" class="ident">forEachP</a>(<a href="runtime2.go.html#line-1129" class="ident">waitReasonTraceProcStatus</a>, <span class="keyword">func</span>(<label for="r41" class="ident">pp</label> *<a href="runtime2.go.html#line-646" class="ident">p</a>) {</code></span>
<span class="codeline" id="line-553"><code>			<label for="r42" class="ident">tl</label> := <a href="trace2runtime.go.html#line-172" class="ident">traceAcquire</a>()</code></span>
<span class="codeline" id="line-554"><code>			<span class="keyword">if</span> !<label for="r41" class="ident">pp</label>.<a href="runtime2.go.html#line-707" class="ident">trace</a>.<a href="trace2status.go.html#line-200" class="ident">statusWasTraced</a>(<label for="r42" class="ident">tl</label>.<a href="trace2runtime.go.html#line-157" class="ident">gen</a>) {</code></span>
<span class="codeline" id="line-555"><code>				<label for="r42" class="ident">tl</label>.<a href="trace2buf.go.html#line-33" class="ident">writer</a>().<a href="trace2status.go.html#line-72" class="ident">writeProcStatusForP</a>(<label for="r41" class="ident">pp</label>, <a href="../../pkg/builtin.html#name-false" class="ident">false</a>).<a href="trace2buf.go.html#line-49" class="ident">end</a>()</code></span>
<span class="codeline" id="line-556"><code>			}</code></span>
<span class="codeline" id="line-557"><code>			<a href="trace2runtime.go.html#line-237" class="ident">traceRelease</a>(<label for="r42" class="ident">tl</label>)</code></span>
<span class="codeline" id="line-558"><code>		})</code></span>
<span class="codeline" id="line-559"><code>		<span class="comment">// Perform status reset on dead Ps because they just appear as idle.</span></code></span>
<span class="codeline" id="line-560"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-561"><code><span class="comment">		// Holding worldsema prevents allp from changing.</span></code></span>
<span class="codeline" id="line-562"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-563"><code><span class="comment">		// TODO(mknyszek): Consider explicitly emitting ProcCreate and ProcDestroy</span></code></span>
<span class="codeline" id="line-564"><code><span class="comment">		// events to indicate whether a P exists, rather than just making its</span></code></span>
<span class="codeline" id="line-565"><code><span class="comment">		// existence implicit.</span></code></span>
<span class="codeline" id="line-566"><code>		<span class="keyword">for</span> <label for="r43" class="ident">_</label>, <label for="r44" class="ident">pp</label> := <span class="keyword">range</span> <a href="runtime2.go.html#line-1200" class="ident">allp</a>[<a href="../../pkg/builtin.html#name-len" class="ident">len</a>(<a href="runtime2.go.html#line-1200" class="ident">allp</a>):<a href="../../pkg/builtin.html#name-cap" class="ident">cap</a>(<a href="runtime2.go.html#line-1200" class="ident">allp</a>)] {</code></span>
<span class="codeline" id="line-567"><code>			<label for="r44" class="ident">pp</label>.<a href="runtime2.go.html#line-707" class="ident">trace</a>.<a href="trace2status.go.html#line-193" class="ident">readyNextGen</a>(<a href="#line-643" class="ident">traceNextGen</a>(<label for="r11" class="ident">gen</label>))</code></span>
<span class="codeline" id="line-568"><code>		}</code></span>
<span class="codeline" id="line-569"><code>		<a href="sema.go.html#line-171" class="ident">semrelease</a>(&amp;<a href="proc.go.html#line-1409" class="ident">worldsema</a>)</code></span>
<span class="codeline" id="line-570"><code>	}</code></span>
<span class="codeline" id="line-571"><code></code></span>
<span class="codeline" id="line-572"><code>	<span class="comment">// Block until the trace reader has finished processing the last generation.</span></code></span>
<span class="codeline" id="line-573"><code>	<a href="sema.go.html#line-110" class="ident">semacquire</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-66" class="ident">doneSema</a>[<label for="r11" class="ident">gen</label>%<span class="lit-number">2</span>])</code></span>
<span class="codeline" id="line-574"><code>	<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-575"><code>		<a href="race0.go.html#line-30" class="ident">raceacquire</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-66" class="ident">doneSema</a>[<label for="r11" class="ident">gen</label>%<span class="lit-number">2</span>]))</code></span>
<span class="codeline" id="line-576"><code>	}</code></span>
<span class="codeline" id="line-577"><code></code></span>
<span class="codeline" id="line-578"><code>	<span class="comment">// Double-check that things look as we expect after advancing and perform some</span></code></span>
<span class="codeline" id="line-579"><code><span class="comment">	// final cleanup if the trace has fully stopped.</span></code></span>
<span class="codeline" id="line-580"><code>	<a href="stubs.go.html#line-58" class="ident">systemstack</a>(<span class="keyword">func</span>() {</code></span>
<span class="codeline" id="line-581"><code>		<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-582"><code>		<span class="keyword">if</span> !<a href="#line-32" class="ident">trace</a>.<a href="#line-50" class="ident">full</a>[<label for="r11" class="ident">gen</label>%<span class="lit-number">2</span>].<a href="trace2buf.go.html#line-155" class="ident">empty</a>() {</code></span>
<span class="codeline" id="line-583"><code>			<a href="panic.go.html#line-1016" class="ident">throw</a>(<span class="lit-string">"trace: non-empty full trace buffer for done generation"</span>)</code></span>
<span class="codeline" id="line-584"><code>		}</code></span>
<span class="codeline" id="line-585"><code>		<span class="keyword">if</span> <label for="r10" class="ident">stopTrace</label> {</code></span>
<span class="codeline" id="line-586"><code>			<span class="keyword">if</span> !<a href="#line-32" class="ident">trace</a>.<a href="#line-50" class="ident">full</a>[<span class="lit-number">1</span>-(<label for="r11" class="ident">gen</label>%<span class="lit-number">2</span>)].<a href="trace2buf.go.html#line-155" class="ident">empty</a>() {</code></span>
<span class="codeline" id="line-587"><code>				<a href="panic.go.html#line-1016" class="ident">throw</a>(<span class="lit-string">"trace: non-empty full trace buffer for next generation"</span>)</code></span>
<span class="codeline" id="line-588"><code>			}</code></span>
<span class="codeline" id="line-589"><code>			<span class="keyword">if</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-48" class="ident">reading</a> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> || <a href="#line-32" class="ident">trace</a>.<a href="#line-93" class="ident">reader</a>.<a href="internal/atomic/types.go.html#line-525" class="ident">Load</a>() != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-590"><code>				<a href="panic.go.html#line-1016" class="ident">throw</a>(<span class="lit-string">"trace: reading after shutdown"</span>)</code></span>
<span class="codeline" id="line-591"><code>			}</code></span>
<span class="codeline" id="line-592"><code>			<span class="comment">// Free all the empty buffers.</span></code></span>
<span class="codeline" id="line-593"><code>			<span class="keyword">for</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-49" class="ident">empty</a> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-594"><code>				<label for="r45" class="ident">buf</label> := <a href="#line-32" class="ident">trace</a>.<a href="#line-49" class="ident">empty</a></code></span>
<span class="codeline" id="line-595"><code>				<a href="#line-32" class="ident">trace</a>.<a href="#line-49" class="ident">empty</a> = <label for="r45" class="ident">buf</label>.<a href="trace2buf.go.html#line-161" class="ident">link</a></code></span>
<span class="codeline" id="line-596"><code>				<a href="mem.go.html#line-113" class="ident">sysFree</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(<label for="r45" class="ident">buf</label>), <a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Sizeof" class="ident">Sizeof</a>(*<label for="r45" class="ident">buf</label>), &amp;<a href="mstats.go.html#line-49" class="ident">memstats</a>.<a href="mstats.go.html#line-30" class="ident">other_sys</a>)</code></span>
<span class="codeline" id="line-597"><code>			}</code></span>
<span class="codeline" id="line-598"><code>			<span class="comment">// Clear trace.shutdown and other flags.</span></code></span>
<span class="codeline" id="line-599"><code>			<a href="#line-32" class="ident">trace</a>.<a href="#line-58" class="ident">headerWritten</a> = <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-600"><code>			<a href="#line-32" class="ident">trace</a>.<a href="#line-108" class="ident">shutdown</a>.<a href="internal/atomic/types.go.html#line-174" class="ident">Store</a>(<a href="../../pkg/builtin.html#name-false" class="ident">false</a>)</code></span>
<span class="codeline" id="line-601"><code>		}</code></span>
<span class="codeline" id="line-602"><code>		<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-603"><code>	})</code></span>
<span class="codeline" id="line-604"><code></code></span>
<span class="codeline" id="line-605"><code>	<span class="keyword">if</span> <label for="r10" class="ident">stopTrace</label> {</code></span>
<span class="codeline" id="line-606"><code>		<span class="comment">// Clear the sweep state on every P for the next time tracing is enabled.</span></code></span>
<span class="codeline" id="line-607"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-608"><code><span class="comment">		// It may be stale in the next trace because we may have ended tracing in</span></code></span>
<span class="codeline" id="line-609"><code><span class="comment">		// the middle of a sweep on a P.</span></code></span>
<span class="codeline" id="line-610"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-611"><code><span class="comment">		// It's fine not to call forEachP here because tracing is disabled and we</span></code></span>
<span class="codeline" id="line-612"><code><span class="comment">		// know at this point that nothing is calling into the tracer, but we do</span></code></span>
<span class="codeline" id="line-613"><code><span class="comment">		// need to look at dead Ps too just because GOMAXPROCS could have been called</span></code></span>
<span class="codeline" id="line-614"><code><span class="comment">		// at any point since we stopped tracing, and we have to ensure there's no</span></code></span>
<span class="codeline" id="line-615"><code><span class="comment">		// bad state on dead Ps too. Prevent a STW and a concurrent GOMAXPROCS that</span></code></span>
<span class="codeline" id="line-616"><code><span class="comment">		// might mutate allp by making ourselves briefly non-preemptible.</span></code></span>
<span class="codeline" id="line-617"><code>		<label for="r46" class="ident">mp</label> := <a href="runtime1.go.html#line-579" class="ident">acquirem</a>()</code></span>
<span class="codeline" id="line-618"><code>		<span class="keyword">for</span> <label for="r47" class="ident">_</label>, <label for="r48" class="ident">pp</label> := <span class="keyword">range</span> <a href="runtime2.go.html#line-1200" class="ident">allp</a>[:<a href="../../pkg/builtin.html#name-cap" class="ident">cap</a>(<a href="runtime2.go.html#line-1200" class="ident">allp</a>)] {</code></span>
<span class="codeline" id="line-619"><code>			<label for="r48" class="ident">pp</label>.<a href="runtime2.go.html#line-707" class="ident">trace</a>.<a href="trace2runtime.go.html#line-47" class="ident">inSweep</a> = <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-620"><code>			<label for="r48" class="ident">pp</label>.<a href="runtime2.go.html#line-707" class="ident">trace</a>.<a href="trace2runtime.go.html#line-44" class="ident">maySweep</a> = <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-621"><code>			<label for="r48" class="ident">pp</label>.<a href="runtime2.go.html#line-707" class="ident">trace</a>.<a href="trace2runtime.go.html#line-51" class="ident">swept</a> = <span class="lit-number">0</span></code></span>
<span class="codeline" id="line-622"><code>			<label for="r48" class="ident">pp</label>.<a href="runtime2.go.html#line-707" class="ident">trace</a>.<a href="trace2runtime.go.html#line-51" class="ident">reclaimed</a> = <span class="lit-number">0</span></code></span>
<span class="codeline" id="line-623"><code>		}</code></span>
<span class="codeline" id="line-624"><code>		<a href="runtime1.go.html#line-586" class="ident">releasem</a>(<label for="r46" class="ident">mp</label>)</code></span>
<span class="codeline" id="line-625"><code>	}</code></span>
<span class="codeline" id="line-626"><code></code></span>
<span class="codeline" id="line-627"><code>	<span class="comment">// Release the advance semaphore. If stopTrace is true we're still holding onto</span></code></span>
<span class="codeline" id="line-628"><code><span class="comment">	// traceShutdownSema.</span></code></span>
<span class="codeline" id="line-629"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-630"><code><span class="comment">	// Do a direct handoff. Don't let one caller of traceAdvance starve</span></code></span>
<span class="codeline" id="line-631"><code><span class="comment">	// other calls to traceAdvance.</span></code></span>
<span class="codeline" id="line-632"><code>	<a href="sema.go.html#line-175" class="ident">semrelease1</a>(&amp;<a href="#line-122" class="ident">traceAdvanceSema</a>, <a href="../../pkg/builtin.html#name-true" class="ident">true</a>, <span class="lit-number">0</span>)</code></span>
<span class="codeline" id="line-633"><code></code></span>
<span class="codeline" id="line-634"><code>	<span class="keyword">if</span> <label for="r10" class="ident">stopTrace</label> {</code></span>
<span class="codeline" id="line-635"><code>		<span class="comment">// Stop the traceAdvancer. We can't be holding traceAdvanceSema here because</span></code></span>
<span class="codeline" id="line-636"><code><span class="comment">		// we'll deadlock (we're blocked on the advancer goroutine exiting, but it</span></code></span>
<span class="codeline" id="line-637"><code><span class="comment">		// may be currently trying to acquire traceAdvanceSema).</span></code></span>
<span class="codeline" id="line-638"><code>		<a href="#line-868" class="ident">traceAdvancer</a>.<a href="#line-893" class="ident">stop</a>()</code></span>
<span class="codeline" id="line-639"><code>		<a href="sema.go.html#line-171" class="ident">semrelease</a>(&amp;<a href="#line-123" class="ident">traceShutdownSema</a>)</code></span>
<span class="codeline" id="line-640"><code>	}</code></span>
<span class="codeline" id="line-641"><code>}</code></span>
<span class="codeline" id="line-642"><code></code></span>
<span class="codeline" id="line-643"><code><span class="keyword">func</span> <label for="r49" class="ident"><a href="../../pkg/runtime.html#name-traceNextGen" class="ident">traceNextGen</a></label>(<label for="r50" class="ident">gen</label> <a href="../../pkg/builtin.html#name-uintptr" class="ident">uintptr</a>) <a href="../../pkg/builtin.html#name-uintptr" class="ident">uintptr</a> {</code></span>
<span class="codeline" id="line-644"><code>	<span class="keyword">if</span> <label for="r50" class="ident">gen</label> == ^<a href="../../pkg/builtin.html#name-uintptr" class="ident">uintptr</a>(<span class="lit-number">0</span>) {</code></span>
<span class="codeline" id="line-645"><code>		<span class="comment">// gen is used both %2 and %3 and we want both patterns to continue when we loop around.</span></code></span>
<span class="codeline" id="line-646"><code><span class="comment">		// ^uint32(0) and ^uint64(0) are both odd and multiples of 3. Therefore the next generation</span></code></span>
<span class="codeline" id="line-647"><code><span class="comment">		// we want is even and one more than a multiple of 3. The smallest such number is 4.</span></code></span>
<span class="codeline" id="line-648"><code>		<span class="keyword">return</span> <span class="lit-number">4</span></code></span>
<span class="codeline" id="line-649"><code>	}</code></span>
<span class="codeline" id="line-650"><code>	<span class="keyword">return</span> <label for="r50" class="ident">gen</label> + <span class="lit-number">1</span></code></span>
<span class="codeline" id="line-651"><code>}</code></span>
<span class="codeline" id="line-652"><code></code></span>
<span class="codeline" id="line-653"><code><span class="comment">// traceRegisterLabelsAndReasons re-registers mark worker labels and</span></code></span>
<span class="codeline" id="line-654"><code><span class="comment">// goroutine stop/block reasons in the string table for the provided</span></code></span>
<span class="codeline" id="line-655"><code><span class="comment">// generation. Note: the provided generation must not have started yet.</span></code></span>
<span class="codeline" id="line-656"><code><span class="keyword">func</span> <label for="r51" class="ident"><a href="../../pkg/runtime.html#name-traceRegisterLabelsAndReasons" class="ident">traceRegisterLabelsAndReasons</a></label>(<label for="r52" class="ident">gen</label> <a href="../../pkg/builtin.html#name-uintptr" class="ident">uintptr</a>) {</code></span>
<span class="codeline" id="line-657"><code>	<span class="keyword">for</span> <label for="r53" class="ident">i</label>, <label for="r54" class="ident">label</label> := <span class="keyword">range</span> <a href="mgc.go.html#line-279" class="ident">gcMarkWorkerModeStrings</a>[:] {</code></span>
<span class="codeline" id="line-658"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-97" class="ident">markWorkerLabels</a>[<label for="r52" class="ident">gen</label>%<span class="lit-number">2</span>][<label for="r53" class="ident">i</label>] = <a href="trace2event.go.html#line-88" class="ident">traceArg</a>(<a href="#line-32" class="ident">trace</a>.<a href="#line-71" class="ident">stringTab</a>[<label for="r52" class="ident">gen</label>%<span class="lit-number">2</span>].<a href="trace2string.go.html#line-27" class="ident">put</a>(<label for="r52" class="ident">gen</label>, <label for="r54" class="ident">label</label>))</code></span>
<span class="codeline" id="line-659"><code>	}</code></span>
<span class="codeline" id="line-660"><code>	<span class="keyword">for</span> <label for="r55" class="ident">i</label>, <label for="r56" class="ident">str</label> := <span class="keyword">range</span> <a href="trace2runtime.go.html#line-104" class="ident">traceBlockReasonStrings</a>[:] {</code></span>
<span class="codeline" id="line-661"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-99" class="ident">goBlockReasons</a>[<label for="r52" class="ident">gen</label>%<span class="lit-number">2</span>][<label for="r55" class="ident">i</label>] = <a href="trace2event.go.html#line-88" class="ident">traceArg</a>(<a href="#line-32" class="ident">trace</a>.<a href="#line-71" class="ident">stringTab</a>[<label for="r52" class="ident">gen</label>%<span class="lit-number">2</span>].<a href="trace2string.go.html#line-27" class="ident">put</a>(<label for="r52" class="ident">gen</label>, <label for="r56" class="ident">str</label>))</code></span>
<span class="codeline" id="line-662"><code>	}</code></span>
<span class="codeline" id="line-663"><code>	<span class="keyword">for</span> <label for="r57" class="ident">i</label>, <label for="r58" class="ident">str</label> := <span class="keyword">range</span> <a href="trace2runtime.go.html#line-134" class="ident">traceGoStopReasonStrings</a>[:] {</code></span>
<span class="codeline" id="line-664"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-98" class="ident">goStopReasons</a>[<label for="r52" class="ident">gen</label>%<span class="lit-number">2</span>][<label for="r57" class="ident">i</label>] = <a href="trace2event.go.html#line-88" class="ident">traceArg</a>(<a href="#line-32" class="ident">trace</a>.<a href="#line-71" class="ident">stringTab</a>[<label for="r52" class="ident">gen</label>%<span class="lit-number">2</span>].<a href="trace2string.go.html#line-27" class="ident">put</a>(<label for="r52" class="ident">gen</label>, <label for="r58" class="ident">str</label>))</code></span>
<span class="codeline" id="line-665"><code>	}</code></span>
<span class="codeline" id="line-666"><code>}</code></span>
<span class="codeline" id="line-667"><code></code></span>
<span class="codeline" id="line-668"><code><span class="comment">// ReadTrace returns the next chunk of binary tracing data, blocking until data</span></code></span>
<span class="codeline" id="line-669"><code><span class="comment">// is available. If tracing is turned off and all the data accumulated while it</span></code></span>
<span class="codeline" id="line-670"><code><span class="comment">// was on has been returned, ReadTrace returns nil. The caller must copy the</span></code></span>
<span class="codeline" id="line-671"><code><span class="comment">// returned data before calling ReadTrace again.</span></code></span>
<span class="codeline" id="line-672"><code><span class="comment">// ReadTrace must be called from one goroutine at a time.</span></code></span>
<span class="codeline" id="line-673"><code><span class="keyword">func</span> <label for="r59" class="ident"><a href="../../pkg/runtime.html#name-ReadTrace" class="ident">ReadTrace</a></label>() []<a href="../../pkg/builtin.html#name-byte" class="ident">byte</a> {</code></span>
<span class="codeline" id="line-674"><code><label for="r60" class="ident">top</label>:</code></span>
<span class="codeline" id="line-675"><code>	<span class="keyword">var</span> <label for="r61" class="ident">buf</label> []<a href="../../pkg/builtin.html#name-byte" class="ident">byte</a></code></span>
<span class="codeline" id="line-676"><code>	<span class="keyword">var</span> <label for="r62" class="ident">park</label> <a href="../../pkg/builtin.html#name-bool" class="ident">bool</a></code></span>
<span class="codeline" id="line-677"><code>	<a href="stubs.go.html#line-58" class="ident">systemstack</a>(<span class="keyword">func</span>() {</code></span>
<span class="codeline" id="line-678"><code>		<label for="r61" class="ident">buf</label>, <label for="r62" class="ident">park</label> = <a href="#line-711" class="ident">readTrace0</a>()</code></span>
<span class="codeline" id="line-679"><code>	})</code></span>
<span class="codeline" id="line-680"><code>	<span class="keyword">if</span> <label for="r62" class="ident">park</label> {</code></span>
<span class="codeline" id="line-681"><code>		<a href="proc.go.html#line-385" class="ident">gopark</a>(<span class="keyword">func</span>(<label for="r63" class="ident">gp</label> *<a href="runtime2.go.html#line-422" class="ident">g</a>, <label for="r64" class="ident">_</label> <a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>) <a href="../../pkg/builtin.html#name-bool" class="ident">bool</a> {</code></span>
<span class="codeline" id="line-682"><code>			<span class="keyword">if</span> !<a href="#line-32" class="ident">trace</a>.<a href="#line-93" class="ident">reader</a>.<a href="internal/atomic/types.go.html#line-561" class="ident">CompareAndSwapNoWB</a>(<a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>, <label for="r63" class="ident">gp</label>) {</code></span>
<span class="codeline" id="line-683"><code>				<span class="comment">// We're racing with another reader.</span></code></span>
<span class="codeline" id="line-684"><code><span class="comment">				// Wake up and handle this case.</span></code></span>
<span class="codeline" id="line-685"><code>				<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-686"><code>			}</code></span>
<span class="codeline" id="line-687"><code></code></span>
<span class="codeline" id="line-688"><code>			<span class="keyword">if</span> <label for="r65" class="ident">g2</label> := <a href="#line-835" class="ident">traceReader</a>(); <label for="r63" class="ident">gp</label> == <label for="r65" class="ident">g2</label> {</code></span>
<span class="codeline" id="line-689"><code>				<span class="comment">// New data arrived between unlocking</span></code></span>
<span class="codeline" id="line-690"><code><span class="comment">				// and the CAS and we won the wake-up</span></code></span>
<span class="codeline" id="line-691"><code><span class="comment">				// race, so wake up directly.</span></code></span>
<span class="codeline" id="line-692"><code>				<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-693"><code>			} <span class="keyword">else</span> <span class="keyword">if</span> <label for="r65" class="ident">g2</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-694"><code>				<a href="print.go.html#line-65" class="ident">printlock</a>()</code></span>
<span class="codeline" id="line-695"><code>				<a href="../../pkg/builtin.html#name-println" class="ident">println</a>(<span class="lit-string">"runtime: got trace reader"</span>, <label for="r65" class="ident">g2</label>, <label for="r65" class="ident">g2</label>.<a href="runtime2.go.html#line-457" class="ident">goid</a>)</code></span>
<span class="codeline" id="line-696"><code>				<a href="panic.go.html#line-1016" class="ident">throw</a>(<span class="lit-string">"unexpected trace reader"</span>)</code></span>
<span class="codeline" id="line-697"><code>			}</code></span>
<span class="codeline" id="line-698"><code></code></span>
<span class="codeline" id="line-699"><code>			<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-true" class="ident">true</a></code></span>
<span class="codeline" id="line-700"><code>		}, <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>, <a href="runtime2.go.html#line-1119" class="ident">waitReasonTraceReaderBlocked</a>, <a href="trace2runtime.go.html#line-97" class="ident">traceBlockSystemGoroutine</a>, <span class="lit-number">2</span>)</code></span>
<span class="codeline" id="line-701"><code>		<span class="keyword">goto</span> <label for="r60" class="ident">top</label></code></span>
<span class="codeline" id="line-702"><code>	}</code></span>
<span class="codeline" id="line-703"><code></code></span>
<span class="codeline" id="line-704"><code>	<span class="keyword">return</span> <label for="r61" class="ident">buf</label></code></span>
<span class="codeline" id="line-705"><code>}</code></span>
<span class="codeline" id="line-706"><code></code></span>
<span class="codeline" id="line-707"><code><span class="comment">// readTrace0 is ReadTrace's continuation on g0. This must run on the</span></code></span>
<span class="codeline" id="line-708"><code><span class="comment">// system stack because it acquires trace.lock.</span></code></span>
<span class="codeline" id="line-709"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-710"><code><span class="comment">//go:systemstack</span></code></span>
<span class="codeline" id="line-711"><code><span class="keyword">func</span> <label for="r66" class="ident"><a href="../../pkg/runtime.html#name-readTrace0" class="ident">readTrace0</a></label>() (<label for="r67" class="ident">buf</label> []<a href="../../pkg/builtin.html#name-byte" class="ident">byte</a>, <label for="r68" class="ident">park</label> <a href="../../pkg/builtin.html#name-bool" class="ident">bool</a>) {</code></span>
<span class="codeline" id="line-712"><code>	<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-713"><code>		<span class="comment">// g0 doesn't have a race context. Borrow the user G's.</span></code></span>
<span class="codeline" id="line-714"><code>		<span class="keyword">if</span> <a href="stubs.go.html#line-22" class="ident">getg</a>().<a href="runtime2.go.html#line-504" class="ident">racectx</a> != <span class="lit-number">0</span> {</code></span>
<span class="codeline" id="line-715"><code>			<a href="panic.go.html#line-1016" class="ident">throw</a>(<span class="lit-string">"expected racectx == 0"</span>)</code></span>
<span class="codeline" id="line-716"><code>		}</code></span>
<span class="codeline" id="line-717"><code>		<a href="stubs.go.html#line-22" class="ident">getg</a>().<a href="runtime2.go.html#line-504" class="ident">racectx</a> = <a href="stubs.go.html#line-22" class="ident">getg</a>().<a href="runtime2.go.html#line-436" class="ident">m</a>.<a href="runtime2.go.html#line-563" class="ident">curg</a>.<a href="runtime2.go.html#line-504" class="ident">racectx</a></code></span>
<span class="codeline" id="line-718"><code>		<span class="comment">// (This defer should get open-coded, which is safe on</span></code></span>
<span class="codeline" id="line-719"><code><span class="comment">		// the system stack.)</span></code></span>
<span class="codeline" id="line-720"><code>		<span class="keyword">defer</span> <span class="keyword">func</span>() { <a href="stubs.go.html#line-22" class="ident">getg</a>().<a href="runtime2.go.html#line-504" class="ident">racectx</a> = <span class="lit-number">0</span> }()</code></span>
<span class="codeline" id="line-721"><code>	}</code></span>
<span class="codeline" id="line-722"><code></code></span>
<span class="codeline" id="line-723"><code>	<span class="comment">// This function must not allocate while holding trace.lock:</span></code></span>
<span class="codeline" id="line-724"><code><span class="comment">	// allocation can call heap allocate, which will try to emit a trace</span></code></span>
<span class="codeline" id="line-725"><code><span class="comment">	// event while holding heap lock.</span></code></span>
<span class="codeline" id="line-726"><code>	<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-727"><code></code></span>
<span class="codeline" id="line-728"><code>	<span class="keyword">if</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-93" class="ident">reader</a>.<a href="internal/atomic/types.go.html#line-525" class="ident">Load</a>() != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-729"><code>		<span class="comment">// More than one goroutine reads trace. This is bad.</span></code></span>
<span class="codeline" id="line-730"><code><span class="comment">		// But we rather do not crash the program because of tracing,</span></code></span>
<span class="codeline" id="line-731"><code><span class="comment">		// because tracing can be enabled at runtime on prod servers.</span></code></span>
<span class="codeline" id="line-732"><code>		<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-733"><code>		<a href="../../pkg/builtin.html#name-println" class="ident">println</a>(<span class="lit-string">"runtime: ReadTrace called from multiple goroutines simultaneously"</span>)</code></span>
<span class="codeline" id="line-734"><code>		<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>, <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-735"><code>	}</code></span>
<span class="codeline" id="line-736"><code>	<span class="comment">// Recycle the old buffer.</span></code></span>
<span class="codeline" id="line-737"><code>	<span class="keyword">if</span> <label for="r69" class="ident">buf</label> := <a href="#line-32" class="ident">trace</a>.<a href="#line-48" class="ident">reading</a>; <label for="r69" class="ident">buf</label> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-738"><code>		<label for="r69" class="ident">buf</label>.<a href="trace2buf.go.html#line-161" class="ident">link</a> = <a href="#line-32" class="ident">trace</a>.<a href="#line-49" class="ident">empty</a></code></span>
<span class="codeline" id="line-739"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-49" class="ident">empty</a> = <label for="r69" class="ident">buf</label></code></span>
<span class="codeline" id="line-740"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-48" class="ident">reading</a> = <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a></code></span>
<span class="codeline" id="line-741"><code>	}</code></span>
<span class="codeline" id="line-742"><code>	<span class="comment">// Write trace header.</span></code></span>
<span class="codeline" id="line-743"><code>	<span class="keyword">if</span> !<a href="#line-32" class="ident">trace</a>.<a href="#line-58" class="ident">headerWritten</a> {</code></span>
<span class="codeline" id="line-744"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-58" class="ident">headerWritten</a> = <a href="../../pkg/builtin.html#name-true" class="ident">true</a></code></span>
<span class="codeline" id="line-745"><code>		<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-746"><code>		<span class="keyword">return</span> []<a href="../../pkg/builtin.html#name-byte" class="ident">byte</a>(<span class="lit-string">"go 1.22 trace\x00\x00\x00"</span>), <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-747"><code>	}</code></span>
<span class="codeline" id="line-748"><code></code></span>
<span class="codeline" id="line-749"><code>	<span class="comment">// Read the next buffer.</span></code></span>
<span class="codeline" id="line-750"><code></code></span>
<span class="codeline" id="line-751"><code>	<span class="keyword">if</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-56" class="ident">readerGen</a>.<a href="internal/atomic/types.go.html#line-358" class="ident">Load</a>() == <span class="lit-number">0</span> {</code></span>
<span class="codeline" id="line-752"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-56" class="ident">readerGen</a>.<a href="internal/atomic/types.go.html#line-378" class="ident">Store</a>(<span class="lit-number">1</span>)</code></span>
<span class="codeline" id="line-753"><code>	}</code></span>
<span class="codeline" id="line-754"><code>	<span class="keyword">var</span> <label for="r70" class="ident">gen</label> <a href="../../pkg/builtin.html#name-uintptr" class="ident">uintptr</a></code></span>
<span class="codeline" id="line-755"><code>	<span class="keyword">for</span> {</code></span>
<span class="codeline" id="line-756"><code>		<a href="lockrank_off.go.html#line-47" class="ident">assertLockHeld</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-757"><code>		<label for="r70" class="ident">gen</label> = <a href="#line-32" class="ident">trace</a>.<a href="#line-56" class="ident">readerGen</a>.<a href="internal/atomic/types.go.html#line-358" class="ident">Load</a>()</code></span>
<span class="codeline" id="line-758"><code></code></span>
<span class="codeline" id="line-759"><code>		<span class="comment">// Check to see if we need to block for more data in this generation</span></code></span>
<span class="codeline" id="line-760"><code><span class="comment">		// or if we need to move our generation forward.</span></code></span>
<span class="codeline" id="line-761"><code>		<span class="keyword">if</span> !<a href="#line-32" class="ident">trace</a>.<a href="#line-50" class="ident">full</a>[<label for="r70" class="ident">gen</label>%<span class="lit-number">2</span>].<a href="trace2buf.go.html#line-155" class="ident">empty</a>() {</code></span>
<span class="codeline" id="line-762"><code>			<span class="keyword">break</span></code></span>
<span class="codeline" id="line-763"><code>		}</code></span>
<span class="codeline" id="line-764"><code>		<span class="comment">// Most of the time readerGen is one generation ahead of flushedGen, as the</span></code></span>
<span class="codeline" id="line-765"><code><span class="comment">		// current generation is being read from. Then, once the last buffer is flushed</span></code></span>
<span class="codeline" id="line-766"><code><span class="comment">		// into readerGen, flushedGen will rise to meet it. At this point, the tracer</span></code></span>
<span class="codeline" id="line-767"><code><span class="comment">		// is waiting on the reader to finish flushing the last generation so that it</span></code></span>
<span class="codeline" id="line-768"><code><span class="comment">		// can continue to advance.</span></code></span>
<span class="codeline" id="line-769"><code>		<span class="keyword">if</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-57" class="ident">flushedGen</a>.<a href="internal/atomic/types.go.html#line-358" class="ident">Load</a>() == <label for="r70" class="ident">gen</label> {</code></span>
<span class="codeline" id="line-770"><code>			<span class="keyword">if</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-108" class="ident">shutdown</a>.<a href="internal/atomic/types.go.html#line-167" class="ident">Load</a>() {</code></span>
<span class="codeline" id="line-771"><code>				<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-772"><code></code></span>
<span class="codeline" id="line-773"><code>				<span class="comment">// Wake up anyone waiting for us to be done with this generation.</span></code></span>
<span class="codeline" id="line-774"><code><span class="comment">				//</span></code></span>
<span class="codeline" id="line-775"><code><span class="comment">				// Do this after reading trace.shutdown, because the thread we're</span></code></span>
<span class="codeline" id="line-776"><code><span class="comment">				// waking up is going to clear trace.shutdown.</span></code></span>
<span class="codeline" id="line-777"><code>				<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-778"><code>					<span class="comment">// Model synchronization on trace.doneSema, which te race</span></code></span>
<span class="codeline" id="line-779"><code><span class="comment">					// detector does not see. This is required to avoid false</span></code></span>
<span class="codeline" id="line-780"><code><span class="comment">					// race reports on writer passed to trace.Start.</span></code></span>
<span class="codeline" id="line-781"><code>					<a href="race0.go.html#line-33" class="ident">racerelease</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-66" class="ident">doneSema</a>[<label for="r70" class="ident">gen</label>%<span class="lit-number">2</span>]))</code></span>
<span class="codeline" id="line-782"><code>				}</code></span>
<span class="codeline" id="line-783"><code>				<a href="sema.go.html#line-171" class="ident">semrelease</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-66" class="ident">doneSema</a>[<label for="r70" class="ident">gen</label>%<span class="lit-number">2</span>])</code></span>
<span class="codeline" id="line-784"><code></code></span>
<span class="codeline" id="line-785"><code>				<span class="comment">// We're shutting down, and the last generation is fully</span></code></span>
<span class="codeline" id="line-786"><code><span class="comment">				// read. We're done.</span></code></span>
<span class="codeline" id="line-787"><code>				<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>, <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-788"><code>			}</code></span>
<span class="codeline" id="line-789"><code>			<span class="comment">// The previous gen has had all of its buffers flushed, and</span></code></span>
<span class="codeline" id="line-790"><code><span class="comment">			// there's nothing else for us to read. Advance the generation</span></code></span>
<span class="codeline" id="line-791"><code><span class="comment">			// we're reading from and try again.</span></code></span>
<span class="codeline" id="line-792"><code>			<a href="#line-32" class="ident">trace</a>.<a href="#line-56" class="ident">readerGen</a>.<a href="internal/atomic/types.go.html#line-378" class="ident">Store</a>(<a href="#line-32" class="ident">trace</a>.<a href="#line-102" class="ident">gen</a>.<a href="internal/atomic/types.go.html#line-358" class="ident">Load</a>())</code></span>
<span class="codeline" id="line-793"><code>			<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-794"><code></code></span>
<span class="codeline" id="line-795"><code>			<span class="comment">// Wake up anyone waiting for us to be done with this generation.</span></code></span>
<span class="codeline" id="line-796"><code><span class="comment">			//</span></code></span>
<span class="codeline" id="line-797"><code><span class="comment">			// Do this after reading gen to make sure we can't have the trace</span></code></span>
<span class="codeline" id="line-798"><code><span class="comment">			// advance until we've read it.</span></code></span>
<span class="codeline" id="line-799"><code>			<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-800"><code>				<span class="comment">// See comment above in the shutdown case.</span></code></span>
<span class="codeline" id="line-801"><code>				<a href="race0.go.html#line-33" class="ident">racerelease</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-66" class="ident">doneSema</a>[<label for="r70" class="ident">gen</label>%<span class="lit-number">2</span>]))</code></span>
<span class="codeline" id="line-802"><code>			}</code></span>
<span class="codeline" id="line-803"><code>			<a href="sema.go.html#line-171" class="ident">semrelease</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-66" class="ident">doneSema</a>[<label for="r70" class="ident">gen</label>%<span class="lit-number">2</span>])</code></span>
<span class="codeline" id="line-804"><code></code></span>
<span class="codeline" id="line-805"><code>			<span class="comment">// Reacquire the lock and go back to the top of the loop.</span></code></span>
<span class="codeline" id="line-806"><code>			<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-807"><code>			<span class="keyword">continue</span></code></span>
<span class="codeline" id="line-808"><code>		}</code></span>
<span class="codeline" id="line-809"><code>		<span class="comment">// Wait for new data.</span></code></span>
<span class="codeline" id="line-810"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-811"><code><span class="comment">		// We don't simply use a note because the scheduler</span></code></span>
<span class="codeline" id="line-812"><code><span class="comment">		// executes this goroutine directly when it wakes up</span></code></span>
<span class="codeline" id="line-813"><code><span class="comment">		// (also a note would consume an M).</span></code></span>
<span class="codeline" id="line-814"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-815"><code><span class="comment">		// Before we drop the lock, clear the workAvailable flag. Work can</span></code></span>
<span class="codeline" id="line-816"><code><span class="comment">		// only be queued with trace.lock held, so this is at least true until</span></code></span>
<span class="codeline" id="line-817"><code><span class="comment">		// we drop the lock.</span></code></span>
<span class="codeline" id="line-818"><code>		<a href="#line-32" class="ident">trace</a>.<a href="#line-51" class="ident">workAvailable</a>.<a href="internal/atomic/types.go.html#line-174" class="ident">Store</a>(<a href="../../pkg/builtin.html#name-false" class="ident">false</a>)</code></span>
<span class="codeline" id="line-819"><code>		<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-820"><code>		<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>, <a href="../../pkg/builtin.html#name-true" class="ident">true</a></code></span>
<span class="codeline" id="line-821"><code>	}</code></span>
<span class="codeline" id="line-822"><code>	<span class="comment">// Pull a buffer.</span></code></span>
<span class="codeline" id="line-823"><code>	<label for="r71" class="ident">tbuf</label> := <a href="#line-32" class="ident">trace</a>.<a href="#line-50" class="ident">full</a>[<label for="r70" class="ident">gen</label>%<span class="lit-number">2</span>].<a href="trace2buf.go.html#line-142" class="ident">pop</a>()</code></span>
<span class="codeline" id="line-824"><code>	<a href="#line-32" class="ident">trace</a>.<a href="#line-48" class="ident">reading</a> = <label for="r71" class="ident">tbuf</label></code></span>
<span class="codeline" id="line-825"><code>	<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<a href="#line-32" class="ident">trace</a>.<a href="#line-35" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-826"><code>	<span class="keyword">return</span> <label for="r71" class="ident">tbuf</label>.<a href="trace2buf.go.html#line-173" class="ident">arr</a>[:<label for="r71" class="ident">tbuf</label>.<a href="trace2buf.go.html#line-163" class="ident">pos</a>], <a href="../../pkg/builtin.html#name-false" class="ident">false</a></code></span>
<span class="codeline" id="line-827"><code>}</code></span>
<span class="codeline" id="line-828"><code></code></span>
<span class="codeline" id="line-829"><code><span class="comment">// traceReader returns the trace reader that should be woken up, if any.</span></code></span>
<span class="codeline" id="line-830"><code><span class="comment">// Callers should first check (traceEnabled() || traceShuttingDown()).</span></code></span>
<span class="codeline" id="line-831"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-832"><code><span class="comment">// This must run on the system stack because it acquires trace.lock.</span></code></span>
<span class="codeline" id="line-833"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-834"><code><span class="comment">//go:systemstack</span></code></span>
<span class="codeline" id="line-835"><code><span class="keyword">func</span> <label for="r72" class="ident"><a href="../../pkg/runtime.html#name-traceReader" class="ident">traceReader</a></label>() *<a href="runtime2.go.html#line-422" class="ident">g</a> {</code></span>
<span class="codeline" id="line-836"><code>	<label for="r73" class="ident">gp</label> := <a href="#line-846" class="ident">traceReaderAvailable</a>()</code></span>
<span class="codeline" id="line-837"><code>	<span class="keyword">if</span> <label for="r73" class="ident">gp</label> == <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> || !<a href="#line-32" class="ident">trace</a>.<a href="#line-93" class="ident">reader</a>.<a href="internal/atomic/types.go.html#line-561" class="ident">CompareAndSwapNoWB</a>(<label for="r73" class="ident">gp</label>, <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a>) {</code></span>
<span class="codeline" id="line-838"><code>		<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a></code></span>
<span class="codeline" id="line-839"><code>	}</code></span>
<span class="codeline" id="line-840"><code>	<span class="keyword">return</span> <label for="r73" class="ident">gp</label></code></span>
<span class="codeline" id="line-841"><code>}</code></span>
<span class="codeline" id="line-842"><code></code></span>
<span class="codeline" id="line-843"><code><span class="comment">// traceReaderAvailable returns the trace reader if it is not currently</span></code></span>
<span class="codeline" id="line-844"><code><span class="comment">// scheduled and should be. Callers should first check that</span></code></span>
<span class="codeline" id="line-845"><code><span class="comment">// (traceEnabled() || traceShuttingDown()) is true.</span></code></span>
<span class="codeline" id="line-846"><code><span class="keyword">func</span> <label for="r74" class="ident"><a href="../../pkg/runtime.html#name-traceReaderAvailable" class="ident">traceReaderAvailable</a></label>() *<a href="runtime2.go.html#line-422" class="ident">g</a> {</code></span>
<span class="codeline" id="line-847"><code>	<span class="comment">// There are three conditions under which we definitely want to schedule</span></code></span>
<span class="codeline" id="line-848"><code><span class="comment">	// the reader:</span></code></span>
<span class="codeline" id="line-849"><code><span class="comment">	// - The reader is lagging behind in finishing off the last generation.</span></code></span>
<span class="codeline" id="line-850"><code><span class="comment">	//   In this case, trace buffers could even be empty, but the trace</span></code></span>
<span class="codeline" id="line-851"><code><span class="comment">	//   advancer will be waiting on the reader, so we have to make sure</span></code></span>
<span class="codeline" id="line-852"><code><span class="comment">	//   to schedule the reader ASAP.</span></code></span>
<span class="codeline" id="line-853"><code><span class="comment">	// - The reader has pending work to process for it's reader generation</span></code></span>
<span class="codeline" id="line-854"><code><span class="comment">	//   (assuming readerGen is not lagging behind). Note that we also want</span></code></span>
<span class="codeline" id="line-855"><code><span class="comment">	//   to be careful *not* to schedule the reader if there's no work to do.</span></code></span>
<span class="codeline" id="line-856"><code><span class="comment">	// - The trace is shutting down. The trace stopper blocks on the reader</span></code></span>
<span class="codeline" id="line-857"><code><span class="comment">	//   to finish, much like trace advancement.</span></code></span>
<span class="codeline" id="line-858"><code><span class="comment">	//</span></code></span>
<span class="codeline" id="line-859"><code><span class="comment">	// We also want to be careful not to schedule the reader if there's no</span></code></span>
<span class="codeline" id="line-860"><code><span class="comment">	// reason to.</span></code></span>
<span class="codeline" id="line-861"><code>	<span class="keyword">if</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-57" class="ident">flushedGen</a>.<a href="internal/atomic/types.go.html#line-358" class="ident">Load</a>() == <a href="#line-32" class="ident">trace</a>.<a href="#line-56" class="ident">readerGen</a>.<a href="internal/atomic/types.go.html#line-358" class="ident">Load</a>() || <a href="#line-32" class="ident">trace</a>.<a href="#line-51" class="ident">workAvailable</a>.<a href="internal/atomic/types.go.html#line-167" class="ident">Load</a>() || <a href="#line-32" class="ident">trace</a>.<a href="#line-108" class="ident">shutdown</a>.<a href="internal/atomic/types.go.html#line-167" class="ident">Load</a>() {</code></span>
<span class="codeline" id="line-862"><code>		<span class="keyword">return</span> <a href="#line-32" class="ident">trace</a>.<a href="#line-93" class="ident">reader</a>.<a href="internal/atomic/types.go.html#line-525" class="ident">Load</a>()</code></span>
<span class="codeline" id="line-863"><code>	}</code></span>
<span class="codeline" id="line-864"><code>	<span class="keyword">return</span> <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a></code></span>
<span class="codeline" id="line-865"><code>}</code></span>
<span class="codeline" id="line-866"><code></code></span>
<span class="codeline" id="line-867"><code><span class="comment">// Trace advancer goroutine.</span></code></span>
<span class="codeline" id="line-868"><code><span class="keyword">var</span> <a href="../../pkg/runtime.html#name-traceAdvancer" class="ident">traceAdvancer</a> <a href="#line-870" class="ident">traceAdvancerState</a></code></span>
<span class="codeline" id="line-869"><code></code></span>
<span class="codeline" id="line-870"><code><span class="keyword">type</span> <a href="../../pkg/runtime.html#name-traceAdvancerState" class="ident">traceAdvancerState</a> <span class="keyword">struct</span> {</code></span>
<span class="codeline" id="line-871"><code>	<a href="../../use/runtime..traceAdvancerState^83818.timer^cd94e.html" class="ident">timer</a> *<a href="#line-909" class="ident">wakeableSleep</a></code></span>
<span class="codeline" id="line-872"><code>	<a href="../../use/runtime..traceAdvancerState^83818.done^a4c3e.html" class="ident">done</a>  <span class="keyword">chan</span> <span class="keyword">struct</span>{}</code></span>
<span class="codeline" id="line-873"><code>}</code></span>
<span class="codeline" id="line-874"><code></code></span>
<span class="codeline" id="line-875"><code><span class="comment">// start starts a new traceAdvancer.</span></code></span>
<span class="codeline" id="line-876"><code><span class="keyword">func</span> (<label for="r75" class="ident">s</label> *<a href="#line-870" class="ident">traceAdvancerState</a>) <label for="r76" class="ident"><a href="../../use/runtime..traceAdvancerState^83818.start^cced2.html" class="ident">start</a></label>() {</code></span>
<span class="codeline" id="line-877"><code>	<span class="comment">// Start a goroutine to periodically advance the trace generation.</span></code></span>
<span class="codeline" id="line-878"><code>	<label for="r75" class="ident">s</label>.<a href="#line-872" class="ident">done</a> = <a href="chan.go.html#line-72">make</a>(<span class="keyword">chan</span> <span class="keyword">struct</span>{})</code></span>
<span class="codeline" id="line-879"><code>	<label for="r75" class="ident">s</label>.<a href="#line-871" class="ident">timer</a> = <a href="#line-918" class="ident">newWakeableSleep</a>()</code></span>
<span class="codeline" id="line-880"><code>	<span class="keyword">go</span> <span class="keyword">func</span>() {</code></span>
<span class="codeline" id="line-881"><code>		<span class="keyword">for</span> <a href="trace2runtime.go.html#line-143" class="ident">traceEnabled</a>() {</code></span>
<span class="codeline" id="line-882"><code>			<span class="comment">// Set a timer to wake us up</span></code></span>
<span class="codeline" id="line-883"><code>			<label for="r75" class="ident">s</label>.<a href="#line-871" class="ident">timer</a>.<a href="#line-935" class="ident">sleep</a>(<a href="../../pkg/builtin.html#name-int64" class="ident">int64</a>(<a href="runtime1.go.html#line-309" class="ident">debug</a>.<a href="runtime1.go.html#line-331" class="ident">traceadvanceperiod</a>))</code></span>
<span class="codeline" id="line-884"><code></code></span>
<span class="codeline" id="line-885"><code>			<span class="comment">// Try to advance the trace.</span></code></span>
<span class="codeline" id="line-886"><code>			<a href="#line-276" class="ident">traceAdvance</a>(<a href="../../pkg/builtin.html#name-false" class="ident">false</a>)</code></span>
<span class="codeline" id="line-887"><code>		}</code></span>
<span class="codeline" id="line-888"><code>		<label for="r75" class="ident">s</label>.<a href="#line-872" class="ident">done</a> &lt;- <span class="keyword">struct</span>{}{}</code></span>
<span class="codeline" id="line-889"><code>	}()</code></span>
<span class="codeline" id="line-890"><code>}</code></span>
<span class="codeline" id="line-891"><code></code></span>
<span class="codeline" id="line-892"><code><span class="comment">// stop stops a traceAdvancer and blocks until it exits.</span></code></span>
<span class="codeline" id="line-893"><code><span class="keyword">func</span> (<label for="r77" class="ident">s</label> *<a href="#line-870" class="ident">traceAdvancerState</a>) <label for="r78" class="ident"><a href="../../use/runtime..traceAdvancerState^83818.stop^6c45c.html" class="ident">stop</a></label>() {</code></span>
<span class="codeline" id="line-894"><code>	<label for="r77" class="ident">s</label>.<a href="#line-871" class="ident">timer</a>.<a href="#line-953" class="ident">wake</a>()</code></span>
<span class="codeline" id="line-895"><code>	&lt;-<label for="r77" class="ident">s</label>.<a href="#line-872" class="ident">done</a></code></span>
<span class="codeline" id="line-896"><code>	<a href="../../pkg/builtin.html#name-close" class="ident">close</a>(<label for="r77" class="ident">s</label>.<a href="#line-872" class="ident">done</a>)</code></span>
<span class="codeline" id="line-897"><code>	<label for="r77" class="ident">s</label>.<a href="#line-871" class="ident">timer</a>.<a href="#line-984" class="ident">close</a>()</code></span>
<span class="codeline" id="line-898"><code>}</code></span>
<span class="codeline" id="line-899"><code></code></span>
<span class="codeline" id="line-900"><code><span class="comment">// traceAdvancePeriod is the approximate period between</span></code></span>
<span class="codeline" id="line-901"><code><span class="comment">// new generations.</span></code></span>
<span class="codeline" id="line-902"><code><span class="keyword">const</span> <a href="../../pkg/runtime.html#name-defaultTraceAdvancePeriod" class="ident">defaultTraceAdvancePeriod</a> = <span class="lit-number">1e9</span> <span class="comment">// 1 second.</span></code></span>
<span class="codeline" id="line-903"><code></code></span>
<span class="codeline" id="line-904"><code><span class="comment">// wakeableSleep manages a wakeable goroutine sleep.</span></code></span>
<span class="codeline" id="line-905"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-906"><code><span class="comment">// Users of this type must call init before first use and</span></code></span>
<span class="codeline" id="line-907"><code><span class="comment">// close to free up resources. Once close is called, init</span></code></span>
<span class="codeline" id="line-908"><code><span class="comment">// must be called before another use.</span></code></span>
<span class="codeline" id="line-909"><code><span class="keyword">type</span> <a href="../../pkg/runtime.html#name-wakeableSleep" class="ident">wakeableSleep</a> <span class="keyword">struct</span> {</code></span>
<span class="codeline" id="line-910"><code>	<a href="../../use/runtime..wakeableSleep^9de7a.timer^cd94e.html" class="ident">timer</a> *<a href="time.go.html#line-18" class="ident">timer</a></code></span>
<span class="codeline" id="line-911"><code></code></span>
<span class="codeline" id="line-912"><code>	<span class="comment">// lock protects access to wakeup, but not send/recv on it.</span></code></span>
<span class="codeline" id="line-913"><code>	<a href="../../use/runtime..wakeableSleep^9de7a.lock^0c030.html" class="ident">lock</a>   <a href="runtime2.go.html#line-164" class="ident">mutex</a></code></span>
<span class="codeline" id="line-914"><code>	<a href="../../use/runtime..wakeableSleep^9de7a.wakeup^1041c.html" class="ident">wakeup</a> <span class="keyword">chan</span> <span class="keyword">struct</span>{}</code></span>
<span class="codeline" id="line-915"><code>}</code></span>
<span class="codeline" id="line-916"><code></code></span>
<span class="codeline" id="line-917"><code><span class="comment">// newWakeableSleep initializes a new wakeableSleep and returns it.</span></code></span>
<span class="codeline" id="line-918"><code><span class="keyword">func</span> <label for="r79" class="ident"><a href="../../pkg/runtime.html#name-newWakeableSleep" class="ident">newWakeableSleep</a></label>() *<a href="#line-909" class="ident">wakeableSleep</a> {</code></span>
<span class="codeline" id="line-919"><code>	<label for="r80" class="ident">s</label> := <a href="../../pkg/builtin.html#name-new" class="ident">new</a>(<a href="#line-909" class="ident">wakeableSleep</a>)</code></span>
<span class="codeline" id="line-920"><code>	<a href="lockrank_off.go.html#line-16" class="ident">lockInit</a>(&amp;<label for="r80" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>, <a href="lockrank.go.html#line-27" class="ident">lockRankWakeableSleep</a>)</code></span>
<span class="codeline" id="line-921"><code>	<label for="r80" class="ident">s</label>.<a href="#line-914" class="ident">wakeup</a> = <a href="chan.go.html#line-72">make</a>(<span class="keyword">chan</span> <span class="keyword">struct</span>{}, <span class="lit-number">1</span>)</code></span>
<span class="codeline" id="line-922"><code>	<label for="r80" class="ident">s</label>.<a href="#line-910" class="ident">timer</a> = <a href="../../pkg/builtin.html#name-new" class="ident">new</a>(<a href="time.go.html#line-18" class="ident">timer</a>)</code></span>
<span class="codeline" id="line-923"><code>	<label for="r80" class="ident">s</label>.<a href="#line-910" class="ident">timer</a>.<a href="time.go.html#line-32" class="ident">arg</a> = <label for="r80" class="ident">s</label></code></span>
<span class="codeline" id="line-924"><code>	<label for="r80" class="ident">s</label>.<a href="#line-910" class="ident">timer</a>.<a href="time.go.html#line-31" class="ident">f</a> = <span class="keyword">func</span>(<label for="r81" class="ident">s</label> <a href="../../pkg/builtin.html#name-any" class="ident">any</a>, <label for="r82" class="ident">_</label> <a href="../../pkg/builtin.html#name-uintptr" class="ident">uintptr</a>) {</code></span>
<span class="codeline" id="line-925"><code>		<label for="r81" class="ident">s</label>.(*<a href="#line-909" class="ident">wakeableSleep</a>).<a href="#line-953" class="ident">wake</a>()</code></span>
<span class="codeline" id="line-926"><code>	}</code></span>
<span class="codeline" id="line-927"><code>	<span class="keyword">return</span> <label for="r80" class="ident">s</label></code></span>
<span class="codeline" id="line-928"><code>}</code></span>
<span class="codeline" id="line-929"><code></code></span>
<span class="codeline" id="line-930"><code><span class="comment">// sleep sleeps for the provided duration in nanoseconds or until</span></code></span>
<span class="codeline" id="line-931"><code><span class="comment">// another goroutine calls wake.</span></code></span>
<span class="codeline" id="line-932"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-933"><code><span class="comment">// Must not be called by more than one goroutine at a time and</span></code></span>
<span class="codeline" id="line-934"><code><span class="comment">// must not be called concurrently with close.</span></code></span>
<span class="codeline" id="line-935"><code><span class="keyword">func</span> (<label for="r83" class="ident">s</label> *<a href="#line-909" class="ident">wakeableSleep</a>) <label for="r84" class="ident"><a href="../../use/runtime..wakeableSleep^9de7a.sleep^0afa5.html" class="ident">sleep</a></label>(<label for="r85" class="ident">ns</label> <a href="../../pkg/builtin.html#name-int64" class="ident">int64</a>) {</code></span>
<span class="codeline" id="line-936"><code>	<a href="time.go.html#line-231" class="ident">resetTimer</a>(<label for="r83" class="ident">s</label>.<a href="#line-910" class="ident">timer</a>, <a href="time_nofake.go.html#line-18" class="ident">nanotime</a>()+<label for="r85" class="ident">ns</label>)</code></span>
<span class="codeline" id="line-937"><code>	<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<label for="r83" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-938"><code>	<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-939"><code>		<a href="race0.go.html#line-30" class="ident">raceacquire</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<label for="r83" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>))</code></span>
<span class="codeline" id="line-940"><code>	}</code></span>
<span class="codeline" id="line-941"><code>	<label for="r86" class="ident">wakeup</label> := <label for="r83" class="ident">s</label>.<a href="#line-914" class="ident">wakeup</a></code></span>
<span class="codeline" id="line-942"><code>	<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-943"><code>		<a href="race0.go.html#line-33" class="ident">racerelease</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<label for="r83" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>))</code></span>
<span class="codeline" id="line-944"><code>	}</code></span>
<span class="codeline" id="line-945"><code>	<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<label for="r83" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-946"><code>	&lt;-<label for="r86" class="ident">wakeup</label></code></span>
<span class="codeline" id="line-947"><code>	<a href="time.go.html#line-222" class="ident">stopTimer</a>(<label for="r83" class="ident">s</label>.<a href="#line-910" class="ident">timer</a>)</code></span>
<span class="codeline" id="line-948"><code>}</code></span>
<span class="codeline" id="line-949"><code></code></span>
<span class="codeline" id="line-950"><code><span class="comment">// wake awakens any goroutine sleeping on the timer.</span></code></span>
<span class="codeline" id="line-951"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-952"><code><span class="comment">// Safe for concurrent use with all other methods.</span></code></span>
<span class="codeline" id="line-953"><code><span class="keyword">func</span> (<label for="r87" class="ident">s</label> *<a href="#line-909" class="ident">wakeableSleep</a>) <label for="r88" class="ident"><a href="../../use/runtime..wakeableSleep^9de7a.wake^51391.html" class="ident">wake</a></label>() {</code></span>
<span class="codeline" id="line-954"><code>	<span class="comment">// Grab the wakeup channel, which may be nil if we're</span></code></span>
<span class="codeline" id="line-955"><code><span class="comment">	// racing with close.</span></code></span>
<span class="codeline" id="line-956"><code>	<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<label for="r87" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-957"><code>	<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-958"><code>		<a href="race0.go.html#line-30" class="ident">raceacquire</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<label for="r87" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>))</code></span>
<span class="codeline" id="line-959"><code>	}</code></span>
<span class="codeline" id="line-960"><code>	<span class="keyword">if</span> <label for="r87" class="ident">s</label>.<a href="#line-914" class="ident">wakeup</a> != <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a> {</code></span>
<span class="codeline" id="line-961"><code>		<span class="comment">// Non-blocking send.</span></code></span>
<span class="codeline" id="line-962"><code><span class="comment">		//</span></code></span>
<span class="codeline" id="line-963"><code><span class="comment">		// Others may also write to this channel and we don't</span></code></span>
<span class="codeline" id="line-964"><code><span class="comment">		// want to block on the receiver waking up. This also</span></code></span>
<span class="codeline" id="line-965"><code><span class="comment">		// effectively batches together wakeup notifications.</span></code></span>
<span class="codeline" id="line-966"><code>		<a href="chan.go.html#line-693"><span class="keyword">select</span></a> {</code></span>
<span class="codeline" id="line-967"><code>		<span class="keyword">case</span> <label for="r87" class="ident">s</label>.<a href="#line-914" class="ident">wakeup</a> <a href="chan.go.html#line-160">&lt;-</a> <span class="keyword">struct</span>{}{}:</code></span>
<span class="codeline" id="line-968"><code>		<span class="keyword">default</span>:</code></span>
<span class="codeline" id="line-969"><code>		}</code></span>
<span class="codeline" id="line-970"><code>	}</code></span>
<span class="codeline" id="line-971"><code>	<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-972"><code>		<a href="race0.go.html#line-33" class="ident">racerelease</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<label for="r87" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>))</code></span>
<span class="codeline" id="line-973"><code>	}</code></span>
<span class="codeline" id="line-974"><code>	<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<label for="r87" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-975"><code>}</code></span>
<span class="codeline" id="line-976"><code></code></span>
<span class="codeline" id="line-977"><code><span class="comment">// close wakes any goroutine sleeping on the timer and prevents</span></code></span>
<span class="codeline" id="line-978"><code><span class="comment">// further sleeping on it.</span></code></span>
<span class="codeline" id="line-979"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-980"><code><span class="comment">// Once close is called, the wakeableSleep must no longer be used.</span></code></span>
<span class="codeline" id="line-981"><code><span class="comment">//</span></code></span>
<span class="codeline" id="line-982"><code><span class="comment">// It must only be called once no goroutine is sleeping on the</span></code></span>
<span class="codeline" id="line-983"><code><span class="comment">// timer *and* nothing else will call wake concurrently.</span></code></span>
<span class="codeline" id="line-984"><code><span class="keyword">func</span> (<label for="r89" class="ident">s</label> *<a href="#line-909" class="ident">wakeableSleep</a>) <label for="r90" class="ident"><a href="../../use/runtime..wakeableSleep^9de7a.close^310ff.html" class="ident">close</a></label>() {</code></span>
<span class="codeline" id="line-985"><code>	<span class="comment">// Set wakeup to nil so that a late timer ends up being a no-op.</span></code></span>
<span class="codeline" id="line-986"><code>	<a href="lock_futex.go.html#line-51" class="ident">lock</a>(&amp;<label for="r89" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-987"><code>	<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-988"><code>		<a href="race0.go.html#line-30" class="ident">raceacquire</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<label for="r89" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>))</code></span>
<span class="codeline" id="line-989"><code>	}</code></span>
<span class="codeline" id="line-990"><code>	<label for="r91" class="ident">wakeup</label> := <label for="r89" class="ident">s</label>.<a href="#line-914" class="ident">wakeup</a></code></span>
<span class="codeline" id="line-991"><code>	<label for="r89" class="ident">s</label>.<a href="#line-914" class="ident">wakeup</a> = <a href="../../pkg/builtin.html#name-nil" class="ident">nil</a></code></span>
<span class="codeline" id="line-992"><code></code></span>
<span class="codeline" id="line-993"><code>	<span class="comment">// Close the channel.</span></code></span>
<span class="codeline" id="line-994"><code>	<a href="../../pkg/builtin.html#name-close" class="ident">close</a>(<label for="r91" class="ident">wakeup</label>)</code></span>
<span class="codeline" id="line-995"><code></code></span>
<span class="codeline" id="line-996"><code>	<span class="keyword">if</span> <a href="race0.go.html#line-15" class="ident">raceenabled</a> {</code></span>
<span class="codeline" id="line-997"><code>		<a href="race0.go.html#line-33" class="ident">racerelease</a>(<a href="../../pkg/unsafe.html" class="ident i1">unsafe</a>.<a href="../../pkg/unsafe.html#name-Pointer" class="ident">Pointer</a>(&amp;<label for="r89" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>))</code></span>
<span class="codeline" id="line-998"><code>	}</code></span>
<span class="codeline" id="line-999"><code>	<a href="lock_futex.go.html#line-120" class="ident">unlock</a>(&amp;<label for="r89" class="ident">s</label>.<a href="#line-913" class="ident">lock</a>)</code></span>
<span class="codeline" id="line-1000"><code>	<span class="keyword">return</span></code></span>
<span class="codeline" id="line-1001"><code>}</code></span>
</pre><pre id="footer">
<table><tr><td><img src="../../png/go101-twitter.png"></td>
<td>The pages are generated with <a href="https://go101.org/apps-and-libs/golds.html"><b>Golds</b></a> <i>v0.6.8</i>. (GOOS=linux GOARCH=amd64)
<b>Golds</b> is a <a href="https://go101.org">Go 101</a> project developed by <a href="https://tapirgames.com">Tapir Liu</a>.
PR and bug reports are welcome and can be submitted to <a href="https://github.com/go101/golds">the issue list</a>.
Please follow <a href="https://twitter.com/go100and1">@Go100and1</a> (reachable from the left QR code) to get the latest news of <b>Golds</b>.</td></tr></table></pre>